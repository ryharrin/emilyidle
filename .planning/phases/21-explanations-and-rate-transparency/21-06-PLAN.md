---
phase: 21-explanations-and-rate-transparency
plan: 06
type: execute
wave: 3
depends_on:
  - 21-03
  - 21-04
  - 21-05
files_modified:
  - tests/explanations.spec.ts
autonomous: true

must_haves:
  truths:
    - "Contextual explanations and rate breakdowns are regression-protected by e2e coverage"
    - "Currency explanations are reachable from the primary currency display"
  artifacts:
    - path: "tests/explanations.spec.ts"
      provides: "Playwright coverage for explain triggers + rate breakdown disclosure"
  key_links:
    - from: "tests/explanations.spec.ts"
      to: "data-testid=explain-gates"
      via: "ExplainButton test id"
      pattern: "explain-gates"
---

<objective>
Add Playwright coverage that locks in Phase 21 behaviors: explain triggers open the correct help section and rate breakdown disclosures render.

Purpose: Prevent regressions to GUIDE-02 / GUIDE-03 / CLAR-03 as Phase 22-24 adds more UX.
Output: A dedicated e2e spec for explanations + rate transparency.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@tests/collection-loop.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add e2e coverage for explain triggers + rate breakdown disclosure</name>
  <files>tests/explanations.spec.ts</files>
  <action>
Create `tests/explanations.spec.ts` with Playwright coverage:

 1) Currency explain trigger:
 - From the header area, click `data-testid=explain-currencies`.
 - Assert help modal is visible and `data-testid=help-active-section` contains the currencies section title.

 2) Purchase gate explain trigger:
- Seed a state that triggers the classic enjoyment gate (copy the seeded state from `tests/collection-loop.spec.ts` "enjoyment gate locks classic purchase").
- Navigate to Vault and locate `data-testid=purchase-gate-classic`.
- Click `data-testid=explain-gates` inside the gate badge.
- Assert help modal is visible and `data-testid=help-active-section` contains the gates section title.

 3) Stats rate breakdown disclosure:
- Navigate to Stats.
- Expand `data-testid=cash-rate-breakdown` and `data-testid=enjoyment-rate-breakdown`.
- Assert each contains at least one line item label (e.g., "Event", "Softcap", "Therapist") so we know the breakdown is actually rendered.

 4) Nostalgia unlock order explain trigger:
- Seed a minimal state with `nostalgiaResets >= 1` so the unlock store is visible.
- Navigate to Nostalgia and click `data-testid=explain-nostalgia-unlocks`.
- Assert help modal active section title matches the nostalgia unlocks section.

 Selector rules:
- Prefer `getByTestId` and visible text.
- Avoid brittle CSS selectors.
 - Use the literal section ids from `HELP_SECTION_IDS` (`currencies`, `gates`, `rates`, `nostalgia-unlocks`) so `data-testid=explain-*` stays stable.
  </action>
  <verify>pnpm -s run test:e2e -- tests/explanations.spec.ts</verify>
  <done>
- New e2e spec passes.
- The spec proves ExplainButtons open help to the correct section and that rate breakdown disclosures render.
  </done>
</task>

</tasks>

<verification>
- `pnpm -s run test:e2e -- tests/explanations.spec.ts`
</verification>

<success_criteria>
- A CI-level signal exists for Phase 21 behaviors (explanations + rate transparency).
</success_criteria>

<output>
After completion, create `.planning/phases/21-explanations-and-rate-transparency/21-06-SUMMARY.md`
</output>
