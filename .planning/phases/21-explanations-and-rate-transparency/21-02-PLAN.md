---
phase: 21-explanations-and-rate-transparency
plan: 02
type: execute
wave: 1
depends_on:
  - 20-01
  - 20-02
files_modified:
  - src/App.tsx
  - src/style.css
  - src/ui/help/helpContent.ts
  - src/ui/help/helpContext.tsx
  - src/ui/help/ExplainButton.tsx
  - src/ui/help/HelpModal.tsx
autonomous: true

must_haves:
  truths:
    - "UI can open Help directly to a specific explanation section (no scrolling / hunting)"
    - "Displayed enjoyment/sec matches the simulation behavior under events"
    - "Primary currency displays link to the currencies help section"
  artifacts:
    - path: "src/ui/help/helpContent.ts"
      provides: "Help sections covering currencies, gates, rates, and nostalgia unlock order"
    - path: "src/ui/help/helpContext.tsx"
      provides: "useHelp() API for point-of-use explain triggers"
    - path: "src/ui/help/ExplainButton.tsx"
      provides: "Reusable help trigger button (tap/click friendly)"
  key_links:
    - from: "src/ui/help/ExplainButton.tsx"
      to: "src/ui/help/helpContext.tsx"
      via: "useHelp() -> openHelpTo(sectionId)"
      pattern: "openHelpTo\("
---

<objective>
Create the canonical explanation surface for Phase 21: stable help section ids + a reusable "Explain" trigger so tabs can open Help at the right content.

Purpose: Satisfy GUIDE-02 and GUIDE-03 via point-of-use, tap-friendly explanations (no hover tooltips).
Output: Expanded helpContent + ExplainButton + Help context wiring + enjoyment rate display fix.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/20-help-iconography/20-02-PLAN.md
@.planning/phases/21-explanations-and-rate-transparency/21-RESEARCH.md

@src/App.tsx
@src/ui/help/helpContent.ts
@src/ui/help/HelpModal.tsx
@src/ui/icons/coreIcons.tsx
@src/game/sim.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand Help sections with stable ids for rates and gates</name>
  <files>src/ui/help/helpContent.ts</files>
  <action>
Extend `src/ui/help/helpContent.ts` (created in Phase 20) to include Phase 21 content with stable section ids and concise copy.

Requirements:
- Keep existing section ids stable.
- Add (or refine) sections so the UI can link directly to:
  - Currencies (enjoyment vs dollars vs Memories)
  - Purchase gates (enjoyment gates vs cash spend)
  - Rates & modifiers (base + modifiers, events, softcap, therapist salary)
  - Nostalgia unlock store (why unlocks are ordered, what “Locked” means)

Implementation notes:
- Export a `HELP_SECTION_IDS` const (string-literal ids) so tabs can import ids instead of duplicating strings.
- Pin the literal ids and object shape so ExplainButton test selectors are stable:
  - `HELP_SECTION_IDS = { currencies: "currencies", gates: "gates", rates: "rates", nostalgiaUnlocks: "nostalgia-unlocks" }`
- Keep content short: 1-2 paragraphs + a short bullet list per section.
  </action>
  <verify>pnpm -s run typecheck</verify>
  <done>
- `HELP_SECTION_IDS` exists and includes ids for gates/rates/nostalgia unlocks.
- `HELP_SECTIONS` includes Phase 21 sections with point-of-use wording.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Help context + ExplainButton reusable trigger</name>
  <files>src/ui/help/helpContext.tsx
src/ui/help/ExplainButton.tsx
src/style.css</files>
  <action>
Create a lightweight Help context and a reusable ExplainButton so tab components can trigger Help without prop drilling.

1) Create `src/ui/help/helpContext.tsx`:
- Export `HelpProvider` and `useHelp()`.
- Context value: `{ openHelpTo: (sectionId: string) => void }`.
- `useHelp()` throws a clear error if used outside provider.

2) Create `src/ui/help/ExplainButton.tsx`:
- Renders a small button using `HelpIcon` (`src/ui/icons/coreIcons.tsx`).
- Props: `{ sectionId: string; label?: string; className?: string }`.
- Accessibility: `type="button"`, `aria-label` defaults to `label ?? "Explain"`.
- Add `data-testid={\`explain-${sectionId}\`}` for Playwright.
- On click: `useHelp().openHelpTo(sectionId)`.

3) Add minimal CSS in `src/style.css`:
- A `.explain-button` class for inline placement (inline-flex, gap, small padding).
- Ensure the SVG icon aligns with text and inherits `currentColor`.

Do NOT add tooltip behavior; this must be tap/click friendly.
  </action>
  <verify>pnpm -s run typecheck</verify>
  <done>
- `ExplainButton` can be dropped into tabs and opens help via context.
- Styling is usable inline next to labels on desktop and mobile.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire HelpProvider + openHelpTo helper and fix enjoyment/sec display</name>
  <files>src/App.tsx
src/ui/help/HelpModal.tsx</files>
  <action>
Update `src/App.tsx` (building on Phase 20 Help wiring):

1) Add an `openHelpTo(sectionId: string)` helper that:
- Sets help open state true.
- Sets the active section id to `sectionId`.
- Updates the existing "lastSectionId" persistence (same behavior as if the user selected that section in the modal).

2) Wrap the rendered app content in `<HelpProvider value={{ openHelpTo }}>` (or equivalent API you create), so tabs can call `useHelp()`.

3) Fix the displayed enjoyment/sec to match simulation under events:
- In the `stats` useMemo, compute `enjoymentRate = getEnjoymentRateCentsPerSec(state) * eventMultiplier`.
- Do not change simulation; this is display-only.

4) Add a currency ExplainButton near the primary currency displays:
- Place `ExplainButton sectionId={HELP_SECTION_IDS.currencies}` next to the cash/enjoyment display in the header area (keep layout tight for mobile).
- Keep it inline with existing labels; no new panel or tooltip.

Update `src/ui/help/HelpModal.tsx` (created in Phase 20) with one test-friendly hook:
- Add `data-testid="help-active-section"` on the active section title element so Playwright can assert which section is open.
  </action>
  <verify>pnpm -s run typecheck</verify>
  <done>
- Tabs can programmatically open Help to an explicit section id.
- Enjoyment/sec displayed in the header and Stats matches event-multiplied simulation behavior.
- Help modal exposes `data-testid="help-active-section"`.
  </done>
</task>

</tasks>

<verification>
- `pnpm -s run typecheck`
- `pnpm -s run test:unit`
</verification>

<success_criteria>
- A point-of-use ExplainButton can open Help directly to gates/rates/nostalgia content.
- Enjoyment/sec display no longer diverges from simulation when an event multiplier is active.
</success_criteria>

<output>
After completion, create `.planning/phases/21-explanations-and-rate-transparency/21-02-SUMMARY.md`
</output>
