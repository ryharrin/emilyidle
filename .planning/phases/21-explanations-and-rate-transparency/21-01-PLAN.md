---
phase: 21-explanations-and-rate-transparency
plan: 01
type: execute
wave: 1
depends_on:
  - 20-02
files_modified:
  - src/game/selectors/index.ts
  - tests/rate-breakdowns.unit.test.ts
autonomous: true

must_haves:
  truths:
    - "Rates can be represented as base + modifiers for cash and enjoyment"
    - "Breakdown totals match the existing authoritative rate selectors"
  artifacts:
    - path: "src/game/selectors/index.ts"
      provides: "getCashRateBreakdown/getEnjoymentRateBreakdown (and types)"
    - path: "tests/rate-breakdowns.unit.test.ts"
      provides: "Unit coverage for breakdown totals and key modifier terms"
  key_links:
    - from: "src/game/state.ts"
      to: "src/game/selectors/index.ts"
      via: "re-export (export * from ./selectors)"
      pattern: "export \* from \"\\./selectors\\\""
---

<objective>
Expose the existing cash/enjoyment rate math as a structured breakdown (base + modifiers) so the UI can explain rates without re-deriving formulas.

Purpose: Satisfy CLAR-03 while keeping all authoritative math in selectors.
Output: New breakdown selector exports + unit tests proving totals match existing selectors.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/21-explanations-and-rate-transparency/21-RESEARCH.md

@src/game/selectors/index.ts
@src/game/sim.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rate breakdown selector exports</name>
  <files>src/game/selectors/index.ts</files>
  <action>
Add new pure selector helpers (no Date.now, no browser APIs) that surface a stable breakdown shape for UI.

Implement in `src/game/selectors/index.ts` (adjacent to existing rate formulas so constants and helpers stay shared):

- Types:
  - `RateBreakdownMultiplierTerm` (id, label, multiplier)
  - `RateBreakdownAddendTerm` (id, label, centsPerSec)
  - `EnjoymentRateBreakdown` and `CashRateBreakdown` (see below)

- Functions (exported):
  - `getEnjoymentRateBreakdown(state: GameState, eventMultiplier?: number): EnjoymentRateBreakdown`
    - Uses: existing per-item enjoyment sum logic + `getPrestigeLegacyMultiplier(state)`.
    - Includes: `eventMultiplier` (default 1) and `effectiveCentsPerSec` that matches `step()` behavior (`getEnjoymentRateCentsPerSec(state) * eventMultiplier`).

  - `getCashRateBreakdown(state: GameState, eventMultiplier?: number): CashRateBreakdown`
    - Uses the same modifier inventory already applied by `getRawIncomeRateCentsPerSec` / `getEffectiveIncomeRateCentsPerSec` / `getTherapistCashRateCentsPerSec`.
    - Includes:
      - Vault income base addend: `(BASE_INCOME_CENTS_PER_SEC + itemIncome)`
      - Vault multipliers (at minimum): upgrades, set bonuses, collection bonus, workshop, maison, catalog tiers, abilities, crafted boosts, prestige legacy
      - Event multiplier as a term applied to both vault and therapist components
      - Softcap details: `softcapCentsPerSec`, `softcapExponent`, and `softcapEfficiency` (effective / raw, clamped to [0, 1])
      - Therapist salary as a separate addend term (pre-event, post-prestige)
      - `totalCentsPerSec` that exactly matches `getTotalCashRateCentsPerSec(state, eventMultiplier)`

Design constraints:
- Keep breakdown terms stable and UI-friendly: ids are string literals, labels are short (no paragraphs).
- Do not change gameplay math; this is a read-only representation.
  </action>
  <verify>pnpm -s run typecheck</verify>
  <done>
- `src/game/selectors/index.ts` exports `getEnjoymentRateBreakdown` and `getCashRateBreakdown`.
- Each breakdown includes base + modifier terms and an `effectiveCentsPerSec` total.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for breakdown totals + key terms</name>
  <files>tests/rate-breakdowns.unit.test.ts</files>
  <action>
Create `tests/rate-breakdowns.unit.test.ts` with Vitest coverage proving breakdown output matches existing selectors.

Test requirements:
- Enjoyment breakdown:
  - Includes `eventMultiplier` term when eventMultiplier != 1.
  - `effectiveCentsPerSec` equals `getEnjoymentRateCentsPerSec(state) * eventMultiplier`.

- Cash breakdown:
  - `totalCentsPerSec` equals `getTotalCashRateCentsPerSec(state, eventMultiplier)`.
  - Includes a softcap efficiency value and it is within [0, 1].
  - Includes a therapist addend term (even if 0 in the baseline state).

Use a small seeded state object (copy the Playwright seeding patterns) rather than relying on runtime/sim.
  </action>
  <verify>pnpm -s run test:unit -- tests/rate-breakdowns.unit.test.ts</verify>
  <done>
- New unit tests pass.
- Tests fail if breakdown totals drift from the authoritative selectors.
  </done>
</task>

</tasks>

<verification>
- `pnpm -s run typecheck`
- `pnpm -s run test:unit -- tests/rate-breakdowns.unit.test.ts`
</verification>

<success_criteria>
- UI can consume a stable cash/enjoyment breakdown that includes base + modifiers.
- Breakdown totals are unit-tested against existing selector totals.
</success_criteria>

<output>
After completion, create `.planning/phases/21-explanations-and-rate-transparency/21-01-SUMMARY.md`
</output>
