---
phase: 15-dual-currency-acquisition
plan: 3
type: execute
wave: 3
depends_on: ["15-01", "15-02"]
files_modified:
  - tests/dual-currency.unit.test.tsx
  - tests/collection-loop.spec.ts
autonomous: true

must_haves:
  truths:
    - "Unit tests cover the dual-gate purchase rules (enjoyment threshold, cash spend only, enjoyment-priority blocking)"
    - "E2E test asserts enjoyment gating disables a watch purchase even when cash is sufficient"
  artifacts:
    - path: "tests/dual-currency.unit.test.tsx"
      provides: "Unit coverage for getWatchPurchaseGate and buyItem behavior"
      contains: "describe(\"dual-currency acquisition\""
    - path: "tests/collection-loop.spec.ts"
      provides: "E2E coverage for enjoyment-gated buy button + inline reason"
      contains: "purchase-gate-classic"
  key_links:
    - from: "tests/collection-loop.spec.ts"
      to: "src/App.tsx"
      via: "data-testid purchase-gate-*"
      pattern: "purchase-gate-"
---

<objective>
Add regression coverage for dual-currency acquisition.

Purpose: Prevent accidental reintroduction of cash-only purchases or UI drift (especially around auto-buy and lock messaging).
Output: Unit test coverage for the gate + one Playwright assertion for the Vault UI lock.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/15-dual-currency-acquisition/15-CONTEXT.md

@src/game/state.ts
@src/App.tsx
@tests/collection-loop.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unit tests for gate semantics and cash-only spending</name>
  <files>tests/dual-currency.unit.test.tsx</files>
  <action>
    Create a new Vitest unit test file `tests/dual-currency.unit.test.tsx` covering core Phase 15 invariants.

    Test cases (use `createInitialState()` and direct imports from `src/game/state.ts`):
    - Gate blocks by enjoyment when enjoyment is below requirement, even if cash is also below requirement.
      - Seed `currencyCents = 0`, `enjoymentCents = 0`, choose `id = "classic"`.
      - Assert `getWatchPurchaseGate(...).ok === false` and `.blocksBy === "enjoyment"`.
    - Gate ok when both requirements met:
      - Seed `currencyCents` to at least `getItemPriceCents(state, id, 1)` and `enjoymentCents` to the requirement.
      - Assert `.ok === true`.
    - `buyItem` spends cash but not enjoyment:
      - Seed state so purchase is ok.
      - Call `buyItem(state, "classic", 1)`.
      - Assert `currencyCents` decreases by price and `enjoymentCents` stays identical.
    - `getMaxAffordableItemCount` returns 0 when enjoyment-locked:
      - Seed high `currencyCents` but `enjoymentCents = 0` for a gated watch.
      - Assert count is 0.

    Keep assertions exact and small; do not snapshot UI.
  </action>
  <verify>pnpm run test:unit</verify>
  <done>
    Unit tests fail if enjoyment gating is removed or if watch buying accidentally spends enjoyment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add an E2E test asserting enjoyment-gated purchase lock</name>
  <files>tests/collection-loop.spec.ts</files>
  <action>
    Extend `tests/collection-loop.spec.ts` with a new test that seeds a save where cash is sufficient but enjoyment is not,
    then asserts the Vault UI shows the enjoyment lock for the classic watch.

    Implementation details:
    - Use `page.addInitScript` to seed `emily-idle:save` version 2 with:
      - `currencyCents`: a large value (e.g. 1_000_000)
      - `enjoymentCents`: 0
      - `items`: include at least 5 starter watches so the "classic" watch is unlocked via milestone, OR set
        `unlockedMilestones` to include "collector-shelf" directly.
      - Include any required fields added in Phase 14+ (therapistCareer, maison fields, etc) by copying the seededState
        pattern already used in this file.
    - Navigate to Vault.
    - Locate the classic watch card (second card is fine) and assert:
      - Its `Buy (` button is disabled.
      - The enjoyment lock message is visible via `data-testid="purchase-gate-classic"`.

    Do not assert on exact copy text; assert on the presence of the gate element and that the button is disabled.
  </action>
  <verify>pnpm run test:e2e</verify>
  <done>
    Playwright fails if the UI stops rendering the enjoyment gate or incorrectly enables a gated purchase.
  </done>
</task>

</tasks>

<verification>
- `pnpm run test:unit` passes
- `pnpm run test:e2e` passes
</verification>

<success_criteria>
- Tests cover the dual-gate rule and prevent cash-only regressions
- One E2E test asserts enjoyment gating is visible and disables purchase in the Vault
</success_criteria>

<output>
After completion, create `.planning/phases/15-dual-currency-acquisition/15-03-SUMMARY.md`
</output>
