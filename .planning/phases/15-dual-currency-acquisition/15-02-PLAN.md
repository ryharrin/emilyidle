---
phase: 15-dual-currency-acquisition
plan: 2
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/App.tsx
  - src/style.css
autonomous: true

must_haves:
  truths:
    - "Vault watch purchase buttons are disabled when enjoyment-gated or cash-gated"
    - "Cash price is always visible; enjoyment requirement appears only when it blocks purchase"
    - "When both cash and enjoyment are insufficient, the UI shows only the enjoyment lock messaging"
    - "Enjoyment drops can re-lock purchases without a page refresh"
  artifacts:
    - path: "src/App.tsx"
      provides: "Vault UI renders dual-currency purchase gating"
      contains: "data-testid=\"purchase-gate-\""
    - path: "src/style.css"
      provides: "Lock icon + blocked styling for enjoyment-gated purchases"
      contains: ".purchase-locked"
  key_links:
    - from: "src/App.tsx"
      to: "src/game/state.ts"
      via: "getWatchPurchaseGate"
      pattern: "getWatchPurchaseGate\(state, item\.id"
---

<objective>
Update the Vault watch purchase UI to reflect dual-currency acquisition rules.

Purpose: Make the new rules legible and consistent with click-time enforcement.
Output: Vault watch cards show cash always, show enjoyment requirement only when blocking, and present a lock state.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/15-dual-currency-acquisition/15-CONTEXT.md
@.planning/phases/15-dual-currency-acquisition/15-RESEARCH.md

@src/App.tsx
@src/style.css
@src/game/state.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire Vault watch cards to getWatchPurchaseGate and render enjoyment lock messaging</name>
  <files>src/App.tsx</files>
  <action>
    Update the Vault watch purchase card rendering to derive all enable/disable state from `getWatchPurchaseGate`.

    In the watch card loop in `src/App.tsx` (`#collection-list`):
    - Import `getWatchPurchaseGate` from `./game/state`.
    - Compute these values for each item:
      - `const singleGate = getWatchPurchaseGate(state, item.id, 1)`
      - `const bulkGate = getWatchPurchaseGate(state, item.id, bulkQty)`
      - Keep `const unlocked = isItemUnlocked(state, item.id)` as a separate gate.

    Button behavior:
    - Single-buy button:
      - `disabled` must be true when `!unlocked || !singleGate.ok`
      - The button label must continue to include the cash price only (locked decision: cash always shown)
        using `formatMoneyFromCents(singleGate.cashPriceCents)`.
    - Bulk-buy button:
      - `disabled` must be true when `!unlocked || bulkQty <= 1 || !bulkGate.ok`
      - The bulk button label uses `bulkGate.cashPriceCents`.

    Per-watch enjoyment lock messaging (locked decisions):
    - Add a small inline block in the card (inside the card-actions area, after the buy buttons is fine) that renders only
      when `unlocked && !singleGate.ok && singleGate.blocksBy === "enjoyment"`.
    - This block must:
      - Show a lock icon presentation (handled by CSS in Task 2).
      - Show the enjoyment requirement amount (formatted via `formatMoneyFromCents(singleGate.enjoymentRequiredCents)`).
      - Provide a per-watch reason message; keep the copy short and inline.
      - When both cash and enjoyment are insufficient, the gate blocks by enjoyment; therefore the UI naturally shows only
        this enjoyment block.
    - Add a stable test hook:
      - `data-testid={\`purchase-gate-${item.id}\`}` on the enjoyment-lock message container.

    Cash naming (locked decision: spend currency is labeled as dollars):
    - In the Vault top stats section and the Stats tab, rename label text from "Vault cash" -> "Vault dollars"
      and "Cash / sec" -> "Dollars / sec" (keep the existing ids `#currency` and `#income` unchanged).
    - In the watch card stats line, rename the per-watch cash rate label from "cash each" to "dollars each".

    Do NOT add any new modal/toast. Inline-only messaging is required.
  </action>
  <verify>pnpm run typecheck</verify>
  <done>
    Vault watch purchase buttons use the shared gate, and enjoyment requirements appear only when they block purchase.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add lock styling and blocked state presentation</name>
  <files>src/style.css</files>
  <action>
    Add minimal styling for enjoyment-locked purchases.

    Requirements:
    - Add a CSS class (and any supporting classes) used by the enjoyment lock message container and/or buttons:
      - `.purchase-locked` (required class name; used by tests and future tweaks)
    - Present a lock icon without changing button accessible names:
      - Use an inline element in the enjoyment message (e.g. `<span className="purchase-lock-icon" aria-hidden="true" />`)
      - Render the icon via CSS (borders/pseudo-elements) or an inline SVG background; avoid adding unicode emoji.
    - Ensure the enjoyment-lock message is visually distinct but still fits the existing UI language (muted text + small badge
      feel is fine).

    Keep changes localized to the purchase lock styling to avoid broad UI churn.
  </action>
  <verify>pnpm run lint</verify>
  <done>
    Enjoyment-locked purchases show a clear lock indicator and inline reason while keeping buy button labels stable.
  </done>
</task>

</tasks>

<verification>
- `pnpm run typecheck` passes
- `pnpm run lint` passes
</verification>

<success_criteria>
- Cash price remains visible on buy buttons even when locked
- Enjoyment requirement displays only when blocking, with a lock icon presentation
- UI labels refer to spend currency as dollars
</success_criteria>

<output>
After completion, create `.planning/phases/15-dual-currency-acquisition/15-02-SUMMARY.md`
</output>
