---
phase: 22-unlock-clarity-and-next-actions
plan: 03
type: execute
wave: 2
depends_on:
  - 22-01
  - 22-02
files_modified:
  - src/App.tsx
  - src/ui/tabs/CollectionTab.tsx
  - src/ui/tabs/CatalogTab.tsx
autonomous: true

must_haves:
  truths:
    - "Collection shows a Next unlocks panel even when other tabs are hidden"
    - "Locked watch items and upgrades explain what unlocks them and show progress"
    - "CTAs can navigate to the correct tab/section via activateTab"
  artifacts:
    - path: "src/ui/tabs/CollectionTab.tsx"
      provides: "NextUnlockPanel integration + per-card lock reasons"
    - path: "src/App.tsx"
      provides: "navigate helper using activateTab + optional scroll"
  key_links:
    - from: "src/ui/tabs/CollectionTab.tsx"
      to: "src/ui/components/NextUnlockPanel.tsx"
      via: "rendered near top of Collection"
      pattern: "data-testid=\"next-unlocks\""
    - from: "src/App.tsx"
      to: "src/ui/tabs/CollectionTab.tsx"
      via: "prop wiring"
      pattern: "onNavigate"
---

<objective>
Wire the Phase 22 unlock clarity UX into the always-visible Collection tab: a “Next unlocks” panel, consistent lock reasons on locked cards, and a reusable navigation+scroll helper.

Purpose: Satisfy CLAR-01 and CLAR-04 without changing gating/persistence.
Output: Collection UX enhancements + App-level navigation helper.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/22-unlock-clarity-and-next-actions/22-RESEARCH.md

@src/App.tsx
@src/ui/tabs/CollectionTab.tsx
@src/ui/tabs/CatalogTab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add navigate+scroll helper and plumb it into tabs</name>
  <files>src/App.tsx</files>
  <action>
In `src/App.tsx`, implement a helper that can be passed to tabs/components:

- Add `const navigateTo = (tabId: TabId, scrollTargetId?: string) => { ... }` that:
  1) calls the existing `activateTab(tabId)` (keep that as the single source of tab selection)
  2) if `scrollTargetId` is provided, schedule a scroll after the tab becomes active:
     - use `requestAnimationFrame(() => requestAnimationFrame(() => { ... }))` to wait for paint
     - then `document.getElementById(scrollTargetId)?.scrollIntoView({ block: "start", behavior: "smooth" })`

Plumb `navigateTo` as a new prop `onNavigate` into:
- `CollectionTab`
- `CatalogTab` (add prop now even if unused until Plan 22-04)

Keep selectors pure: do not move any unlock logic into selectors; this is UI-only wiring.
  </action>
  <verify>pnpm run typecheck</verify>
  <done>
Tabs can receive `onNavigate(tabId, scrollTargetId?)` and App compiles with no behavior change until used.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Next unlocks panel + always-on lock reasons in Collection</name>
  <files>src/ui/tabs/CollectionTab.tsx</files>
  <action>
Update `src/ui/tabs/CollectionTab.tsx`:

1) Props
- Add a new prop: `onNavigate: (tabId: TabId, scrollTargetId?: string) => void`.

2) Next unlocks panel
- Import `NextUnlockPanel`.
- Near the top of the Collection tab content (immediately after the existing Collection header copy), render a `NextUnlockPanel`.
- Build its `items` list from current state using existing visibility rules (do NOT change gating rules):
  - Career tab: visible when `state.unlockedMilestones.includes("collector-shelf")`.
  - Catalog tab: visible when `getUnlockVisibilityRatio(state, "showcase") >= 0.8`.
  - Stats tab: visible when `getAchievementProgressRatio(state, "first-drawer") >= 0.8`.
  - Atelier/Maison/Nostalgia: treat as “locked” until their section is shown, using the same logic as App (`showWorkshopSection`, `showMaisonSection`, `showNostalgiaSection`).
- For each locked entry, show:
  - requirement label (milestone/achievement label or enjoyment threshold label for prestige systems)
  - `current / threshold` and percent
  - progress bar ratio should reflect progress toward reveal where applicable:
    - use `getUnlockRevealProgressRatio(rawRatio)` for tabs revealed at 80%
    - use regular clamped ratio for milestone unlocks (0..1)
  - CTA should always be ONE action: navigate to Vault and scroll to the most relevant section:
    - use `onNavigate("collection", "collection-list")`
    - CTA label: `"Buy watches"`

3) Locked-but-visible cards
- For watch cards:
  - When `!unlocked && item.unlockMilestoneId` render a lock explanation row always (not just at 80%).
  - Use `UnlockHint` with eyebrow `"Locked"`, title `"Unlock requirement"`, detail = milestone requirement label, progress based on `getMilestoneUnlockProgressDetail`.
  - Keep existing "Unlocking soon" tag as-is (it becomes a secondary cue).

- For upgrade cards:
  - When `!unlocked && upgrade.unlockMilestoneId` render the same always-on lock explanation row.

Keep `data-testid` stable on existing elements. Add new test ids only for the new panel/rows.
  </action>
  <verify>pnpm run typecheck</verify>
  <done>
Collection renders (a) a Next unlocks panel and (b) every locked item/upgrade shows its unlock requirement + progress.
  </done>
</task>

</tasks>

<verification>
- `pnpm run lint`
- `pnpm run test:unit`
</verification>

<success_criteria>
- Users can always see what is locked and why from the Collection tab (even if tabs are hidden).
</success_criteria>

<output>
After completion, create `.planning/phases/22-unlock-clarity-and-next-actions/22-03-SUMMARY.md`
</output>
