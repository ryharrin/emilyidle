---
phase: 22-unlock-clarity-and-next-actions
plan: 03
type: execute
wave: 2
depends_on:
  - 22-01
  - 22-02
files_modified:
  - src/App.tsx
  - src/ui/tabs/CollectionTab.tsx
  - src/ui/tabs/CatalogTab.tsx
  - src/ui/tabs/StatsTab.tsx
  - src/ui/tabs/WorkshopTab.tsx
  - src/ui/tabs/MaisonTab.tsx
  - src/ui/tabs/NostalgiaTab.tsx
  - src/ui/tabs/CareerTab.tsx
autonomous: true

must_haves:
  truths:
    - "Collection shows a Next unlocks panel for upcoming tabs tied to collection progress"
    - "Locked watch items and upgrades explain what unlocks them and show progress"
    - "CTAs can navigate to the correct tab/section via activateTab"
  artifacts:
    - path: "src/ui/tabs/CollectionTab.tsx"
      provides: "NextUnlockPanel integration + per-card lock reasons"
    - path: "src/App.tsx"
      provides: "navigate helper using activateTab + optional scroll"
  key_links:
    - from: "src/ui/tabs/CollectionTab.tsx"
      to: "src/ui/components/NextUnlockPanel.tsx"
      via: "rendered near top of Collection"
      pattern: "data-testid=\"next-unlocks\""
    - from: "src/App.tsx"
      to: "src/ui/tabs/CollectionTab.tsx"
      via: "prop wiring"
      pattern: "onNavigate"
---

<objective>
Wire the Phase 22 unlock clarity UX into the always-visible Collection tab: a “Next unlocks” panel, consistent lock reasons on locked cards, and a reusable navigation+scroll helper.

Purpose: Satisfy CLAR-01 and CLAR-04 without changing gating/persistence.
Output: Collection UX enhancements + App-level navigation helper.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/22-unlock-clarity-and-next-actions/22-RESEARCH.md

@src/App.tsx
@src/ui/tabs/CollectionTab.tsx
@src/ui/tabs/CatalogTab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add navigate+scroll helper and plumb it into tabs</name>
  <files>
src/App.tsx
src/ui/tabs/CollectionTab.tsx
src/ui/tabs/CatalogTab.tsx
src/ui/tabs/StatsTab.tsx
src/ui/tabs/WorkshopTab.tsx
src/ui/tabs/MaisonTab.tsx
src/ui/tabs/NostalgiaTab.tsx
src/ui/tabs/CareerTab.tsx
  </files>
  <action>
In `src/App.tsx`, implement a helper that can be passed to tabs/components:

- Add `const navigateTo = (tabId: TabId, scrollTargetId?: string) => { ... }` that:
  1) calls the existing `activateTab(tabId)` (keep that as the single source of tab selection)
  2) if `scrollTargetId` is provided, schedule a scroll after the tab becomes active:
     - use `requestAnimationFrame(() => requestAnimationFrame(() => { ... }))` to wait for paint
     - then `document.getElementById(scrollTargetId)?.scrollIntoView({ block: "start", behavior: "smooth" })`

Plumb `navigateTo` as a new prop `onNavigate` into:
- `CollectionTab`
- `CatalogTab` (add prop now even if unused until Plan 22-04)
- `StatsTab`, `WorkshopTab`, `MaisonTab`, `NostalgiaTab`, `CareerTab` (so empty states can use one CTA without new wiring later)

Keep selectors pure: do not move any unlock logic into selectors; this is UI-only wiring.
  </action>
  <verify>pnpm run typecheck</verify>
  <done>
Tabs can receive `onNavigate(tabId, scrollTargetId?)` and App compiles with no behavior change until used.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Next unlocks panel + always-on lock reasons in Collection</name>
  <files>src/ui/tabs/CollectionTab.tsx</files>
  <action>
Update `src/ui/tabs/CollectionTab.tsx`:

1) Props
- Add a new prop: `onNavigate: (tabId: TabId, scrollTargetId?: string) => void`.

2) Next unlocks panel
- Import `NextUnlockPanel`.
- Import progress helpers from `src/game/state.ts` (re-exported facade).
- Near the top of the Collection tab content (immediately after the existing Collection header copy), render a `NextUnlockPanel`.
- Build its `items` list from current state using existing visibility rules (do NOT change gating rules). Explicit inclusion rules:
  - Use stable ids for each entry: `career`, `catalog`, `stats`, `workshop`, `maison`, `nostalgia`.
  - Career tab entry: include when `!state.unlockedMilestones.includes("collector-shelf")`.
  - Catalog tab entry: include while `getMilestoneUnlockProgressDetail(state, "showcase").ratio < 1` (stay visible after reveal until fully unlocked).
  - Stats tab entry: include while `getAchievementUnlockProgressDetail(state, "first-drawer").ratio < 1` (stay visible after reveal until fully unlocked).
  - Workshop section entry: include while `getPrestigeUnlockProgressDetail(state, "workshop").ratio < 1`.
  - Maison section entry: include while `getPrestigeUnlockProgressDetail(state, "maison").ratio < 1`.
  - Nostalgia section entry: include while `getPrestigeUnlockProgressDetail(state, "nostalgia").ratio < 1`.
  - Per-entry UnlockHint data sources (explicit reveal vs unlock semantics):
    - Career: use `getMilestoneUnlockProgressDetail` for label/current/threshold and use `detail.ratio` directly (progress to full unlock).
    - Catalog: use `getMilestoneUnlockProgressDetail` for label/current/threshold and `getUnlockRevealProgressRatio(detail.ratio)` for progress-to-reveal.
    - Stats: use `getAchievementUnlockProgressDetail` for label/current/threshold and `getUnlockRevealProgressRatio(detail.ratio)` for progress-to-reveal.
    - Workshop/Maison/Nostalgia: use `getPrestigeUnlockProgressDetail` for label/current/threshold and `getUnlockRevealProgressRatio(detail.ratio)` for progress-to-reveal.

  - Formatting rules for `currentLabel`/`thresholdLabel`:
    - For cents-based requirements (milestone `collectionValue`, prestige thresholds): use `formatMoneyFromCents`.
    - For count-based requirements: use `Math.floor(value).toLocaleString()`.

  - UnlockHint copy rules for NextUnlockPanel rows:
    - `eyebrow: "Next unlock"`
    - `title`: "Career", "Catalog", "Stats", "Workshop", "Maison", "Nostalgia"
    - `detail`: requirement label from the corresponding progress detail helper

  - Set CTA `testId` for each entry so Playwright can target it: `next-unlock-cta-${id}`.
- For each locked entry, show:
  - requirement label (milestone/achievement label or enjoyment threshold label for prestige systems)
  - `current / threshold` and percent
  - progress bar ratio should reflect progress toward reveal where applicable:
    - use `getUnlockRevealProgressRatio(rawRatio)` for tabs revealed at 80%
    - use regular clamped ratio for milestone unlocks (0..1)
  - CTA should always be ONE action per entry. Use a per-entry label while keeping the same target:
    - Career/Catalog/Stats: label `"Buy watches"`, target `onNavigate("collection", "collection-list")`
    - Workshop/Maison/Nostalgia: label `"Build collection"`, target `onNavigate("collection", "collection-list")`

  - Visibility rule: keep each entry visible until its `detail.ratio >= 1` (full unlock), even if the tab becomes visible at reveal.

3) Locked-but-visible cards
- For watch cards:
  - When `!isItemUnlocked(state, item.id)` render a lock explanation row always (not just at 80%).
  - Use `UnlockHint` with eyebrow `"Locked"`, title `"Unlock requirement"`, detail = milestone requirement label, progress based on `getMilestoneUnlockProgressDetail`.
  - Add `data-testid={\`locked-item-hint-${item.id}\`}` on the lock row wrapper.
  - Keep existing "Unlocking soon" tag as-is (it becomes a secondary cue).

- For upgrade cards:
  - When `!isUpgradeUnlocked(state, upgrade.id)` render the same always-on lock explanation row.
  - Add `data-testid={\`locked-upgrade-hint-${upgrade.id}\`}` on the lock row wrapper.

4) Anchor for CTA scroll
- Add `id="collection-list"` to the Vault list container used for watch cards so CTAs can scroll reliably.

Keep `data-testid` stable on existing elements. Add new test ids only for the new panel/rows.
  </action>
  <verify>pnpm run typecheck</verify>
  <done>
Collection renders (a) a Next unlocks panel and (b) every locked item/upgrade shows its unlock requirement + progress.
  </done>
</task>

</tasks>

<verification>
- `pnpm run lint`
- `pnpm run test:unit`
</verification>

<success_criteria>
- Users can always see what is locked and why from the Collection tab (even if tabs are hidden).
</success_criteria>

<output>
After completion, create `.planning/phases/22-unlock-clarity-and-next-actions/22-03-SUMMARY.md`
</output>
