---
phase: 22-unlock-clarity-and-next-actions
plan: 01
type: execute
wave: 1
depends_on:
  - 21-06
files_modified:
  - src/game/selectors/index.ts
  - tests/unlock-progress.unit.test.ts
autonomous: true

must_haves:
  truths:
    - "Unlock progress can be displayed as current/threshold + percent"
    - "Progress detail is derived from authoritative milestone/achievement requirements"
  artifacts:
    - path: "src/game/selectors/index.ts"
      provides: "unlock progress detail helpers for milestones/achievements/reveal"
    - path: "tests/unlock-progress.unit.test.ts"
      provides: "Unit coverage for progress detail helper outputs"
  key_links:
    - from: "src/ui/tabs/CollectionTab.tsx"
      to: "src/game/selectors/index.ts"
      via: "import progress detail helpers"
      pattern: "get(Milestone|Achievement).*Progress"
---

<objective>
Add selector-level helper outputs that explain (1) what unlock requirement applies and (2) progress toward the unlock/reveal threshold.

Purpose: Phase 22 needs stable, pure progress detail for lock reasons, progress bars, and “next unlock” callouts.
Output: New selector helpers + unit tests for milestone/achievement progress.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/22-unlock-clarity-and-next-actions/22-RESEARCH.md

@src/game/selectors/index.ts
@src/game/data/milestones.ts
@src/game/model/state.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unlock progress detail selector helpers</name>
  <files>src/game/selectors/index.ts</files>
  <action>
Implement new pure helpers in `src/game/selectors/index.ts` (no Date.now, no DOM, no persistence changes). These helpers exist solely to let UI render lock explanations consistently.

Add types (exported):
- `UnlockProgressDetail`:
  - `label: string` (human label for the requirement, reuse existing label helpers)
  - `current: number` (clamped to [0, threshold] for display)
  - `threshold: number`
  - `ratio: number` (clamped to [0, 1] for display)

Add functions (exported):
- `getMilestoneUnlockProgressDetail(state: GameState, milestoneId: MilestoneId): UnlockProgressDetail`
  - Uses the milestone requirement type to compute current/threshold.
  - For `collectionValue`, treat `current` and `threshold` as cents and expose them as raw numbers (UI will format).
  - Uses `getMilestoneRequirementLabel(milestoneId)` for `label`.

- `getAchievementUnlockProgressDetail(state: GameState, achievementId: AchievementId): UnlockProgressDetail`
  - Uses the achievement requirement type to compute current/threshold.
  - `label` should be a new helper `getAchievementRequirementLabel(achievementId)` (also exported), mirroring `getMilestoneRequirementLabel`.

- `getUnlockRevealProgressRatio(rawRatio: number): number`
  - Returns progress toward the reveal threshold (80%): `Math.min(1, Math.max(0, rawRatio / REVEAL_THRESHOLD_RATIO))`.
  - This is for tabs/systems that become visible at reveal, not necessarily fully unlocked.

Avoid adding any new “fallback defaults” in selectors beyond clamping for display (per Phase 22 research pitfalls).
  </action>
  <verify>pnpm run typecheck</verify>
  <done>
New selector exports exist and are usable by UI without re-deriving requirement math.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit coverage for progress detail helpers</name>
  <files>tests/unlock-progress.unit.test.ts</files>
  <action>
Create `tests/unlock-progress.unit.test.ts` covering:
- Milestone detail for:
  - `collector-shelf` (totalItems)
  - `showcase` (collectionValue)
  - `archive-curator` (catalogDiscovery)
- Achievement detail for:
  - `first-drawer` (totalItems)
- Reveal ratio helper:
  - raw 0 -> 0
  - raw 0.4 -> 0.5
  - raw 0.8 -> 1
  - raw 1.2 -> 1

Use `createInitialState()` and override only the needed fields (keep test state minimal and explicit).
  </action>
  <verify>pnpm run test:unit tests/unlock-progress.unit.test.ts</verify>
  <done>
Unit tests pass and prove the helpers return correct current/threshold/ratio for representative requirement types.
  </done>
</task>

</tasks>

<verification>
- `pnpm run lint`
- `pnpm run test:unit`
</verification>

<success_criteria>
- UI can import unlock progress details without duplicating milestone/achievement math.
</success_criteria>

<output>
After completion, create `.planning/phases/22-unlock-clarity-and-next-actions/22-01-SUMMARY.md`
</output>
