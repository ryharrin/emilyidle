---
phase: 01-foundation
plan: 03
type: execute
domain: persistence
---

<objective>
Add save/load so progress persists across reloads, plus import/export for manual backup.

Purpose: Make the game usable for real play sessions and pave the way for future schema migrations.
Output: Automatic persistence to localStorage, plus export/import UI and basic versioning.
</objective>

<execution_context>
~/.config/opencode/get-shit-done/workflows/execute-phase.md
~/.config/opencode/get-shit-done/templates/summary.md
~/.config/opencode/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement persistence layer with versioned save format</name>
  <files>src/* (persistence module), any state module touched</files>
  <action>
    Add local persistence for the game state.

    Requirements:
    - Define a save format with explicit `version` and `savedAt` fields.
    - Persist to localStorage on a reasonable cadence (debounced/throttled), and also on meaningful actions (e.g., successful purchase).
    - On load, validate the saved structure and handle missing/invalid data safely (reset to defaults if needed).
    - Record `lastSimulatedAt` (or equivalent) to enable future offline progress.

    Avoid:
    - Saving every tick.
    - Silent failures (no signal if save payload is invalid); log meaningful messages.
  </action>
  <verify>
    - Manual: Make progress, reload page, confirm progress restored
    - Manual: Corrupt localStorage value, reload, confirm app resets safely without crashing
  </verify>
  <done>
    State loads from localStorage when valid; otherwise defaults; saving occurs during play.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add export/import save (clipboard/text area)</name>
  <files>src/* (UI + persistence)</files>
  <action>
    Provide a simple export/import mechanism.

    Requirements:
    - Export produces a compact string (JSON or base64) suitable for copy/paste.
    - Import validates payload and version before applying.
    - Import updates runtime state and persists immediately.

    Avoid:
    - Introducing server-side dependencies.
  </action>
  <verify>
    - Manual: Export save, reset storage, import, confirm progress restored
  </verify>
  <done>
    Export/import works and handles invalid payloads gracefully.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Persistent saves + import/export</what-built>
  <how-to-verify>
    1. Run: `npm run dev`
    2. Play for ~15 seconds and buy at least one item
    3. Reload the page; confirm currency/items/income persist
    4. Export save; then clear site data (or use a new private window)
    5. Import the exported save; confirm state restores
    6. Try importing an invalid string; confirm an error is shown and state does not break
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring this plan complete:
- [ ] Reload retains progress
- [ ] Import/export restores progress
- [ ] Invalid saves do not crash the app
</verification>

<success_criteria>
- A versioned save format exists
- localStorage persistence is robust and debounced
- Export/import works for manual backups
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md` with:
- Save schema and version strategy
- Save cadence and when saves occur
- Files created/modified
</output>
