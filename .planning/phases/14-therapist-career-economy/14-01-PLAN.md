---
phase: 14-therapist-career-economy
type: execute
---

<objective>
Add therapist career progression to generate cash alongside enjoyment.

Purpose: Introduce a second money faucet that is not purely tied to watch ownership, setting up Phase 15 dual-currency acquisition.
Output: Therapist career state + selectors + earning mechanics integrated into simulation, with unit coverage and save/load compatibility.
</objective>

<execution_context>
~/.config/opencode/get-shit-done/workflows/execute-phase.md
./summary.md
~/.config/opencode/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Relevant recent decisions and patterns
@.planning/phases/13-enjoyment-economy-foundation/13-01-SUMMARY.md
@.planning/phases/13-enjoyment-economy-foundation/13-02-SUMMARY.md
@.planning/phases/13-enjoyment-economy-foundation/13-RESEARCH.md

# Core domain logic
@src/game/state.ts
@src/game/sim.ts
@src/game/persistence.ts

# Existing unit coverage patterns
@tests/maison.unit.test.tsx

**Tech stack available:** TypeScript, Vitest, React (client-only)
**Established patterns:** State transitions are pure; save decoding validates shape; income/enjoyment flow through `sim.step()`
**Constraining decisions:** Keep save version and localStorage keys unchanged; keep existing `id`/`data-testid` stable
**Issues being addressed:** None
</context>

<tasks>

<task type="checkpoint:decision" gate="blocking">
  <decision>Select therapist career earning model + how it composes with vault cash</decision>
  <context>
    The roadmap goal is to "generate money alongside enjoyment". There are multiple valid interpretations, and the choice affects
    what state we store, what we simulate, and what we display as "Cash / sec".
  </context>
  <options>
    <option id="sessions">
      <name>Active sessions (recommended)</name>
      <pros>
        Therapist career is an explicit faucet/drain loop: spend some enjoyment (cost) to earn cash + XP (payout).
        Avoids confusing interaction with vault softcap/multipliers because earnings are discrete and explicit.
        Provides a natural reengagement mechanic (cooldown / availability).
      </pros>
      <cons>
        Requires new action + cooldown UI and time-based state.
        Not purely "idle" income unless coupled with passive elements.
      </cons>
    </option>
    <option id="passive">
      <name>Passive salary (simple)</name>
      <pros>
        Minimal UX complexity: therapist adds a steady cash/sec stream.
        Integrates naturally into the simulation tick.
      </pros>
      <cons>
        Needs a clear design choice: should therapist salary be subject to vault softcap/events or remain separate?
        Can blur why cash/sec changed unless UI shows a breakdown.
      </cons>
    </option>
    <option id="hybrid">
      <name>Hybrid (passive salary + active sessions)</name>
      <pros>
        Supports both idle pacing and active play.
        More levers for tuning and future upgrades.
      </pros>
      <cons>
        More code surface area, more balancing knobs, higher risk of scope creep.
      </cons>
    </option>
  </options>
  <resume-signal>Select: sessions, passive, or hybrid</resume-signal>
</task>

<task type="auto">
  <name>Task 1: Implement therapist career state + cash generation hooks</name>
  <files>src/game/state.ts, src/game/sim.ts</files>
  <action>
    Add therapist career progression to game state while preserving existing patterns:

    - Add a small, explicit therapist state to `GameState` (and `PersistedGameState` as optional fields) rather than storing
      derived rates.
    - Add selectors so UI and simulation can access the career as a first-class system (avoid proxy-derived values).
    - Add a new selector for total cash rate used by simulation/UI, rather than mutating the meaning of existing selectors:
      - Keep `getRawIncomeRateCentsPerSec` and `getEffectiveIncomeRateCentsPerSec` as "vault cash".
      - Add `getTherapistCashRateCentsPerSec` (if applicable) and `getTotalCashRateCentsPerSec`.
    - Integrate into `sim.step()` by adding therapist earnings to `currencyCents` each tick (or by applying discrete payouts
      if using the sessions option).

    Implementation guidelines by chosen option:

    - sessions:
      - Create an action function (e.g. `performTherapistSession(...)`) that:
        1) checks availability/cooldown, 2) checks enjoyment cost, 3) deducts enjoyment, 4) awards cash + XP,
        5) advances career level when XP thresholds crossed.
      - Store only the minimum timestamps needed for cooldown (e.g. `nextAvailableAtMs`).
      - Do NOT make session payout run through vault softcap / upgrade multipliers unless explicitly decided.

    - passive:
      - Define a simple salary curve: base salary + per-level multiplier (keep everything integer cents).
      - Decide whether salary is multiplied by events (eventMultiplier) and whether it is softcapped; document the decision
        in the eventual SUMMARY.md.

    - hybrid:
      - Implement passive + sessions in a way that keeps the state minimal and avoids duplicated math paths.

    Do not:
    - Change save version or localStorage keys.
    - Hide errors with `as any` / `@ts-ignore`.
    - Change existing `id`/`data-testid` selectors (new UI comes in plan 14-02).
  </action>
  <verify>
    Run `pnpm run typecheck` and `pnpm run test:unit -- tests/maison.unit.test.tsx` to ensure existing economy invariants
    still hold.
  </verify>
  <done>
    Therapist career state exists, earns cash according to the chosen model, and simulation produces cash consistently
    without breaking existing selectors or tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit + save/load coverage for therapist career</name>
  <files>tests/therapist.unit.test.tsx, src/game/persistence.ts, src/game/state.ts</files>
  <action>
    Add focused unit coverage for the therapist career logic and ensure save/load remains compatible:

    - Add `tests/therapist.unit.test.tsx` with a small set of cases:
      - Career starts at defaults on a fresh state.
      - One or more earnings steps (either passive tick or a session) increases `currencyCents` as expected.
      - Career level progression (XP thresholds) works for at least one boundary case.

    - Update `src/game/persistence.ts` sanitization to accept the new therapist fields safely:
      - Validate numeric fields are finite and >= 0.
      - Default missing fields (older saves) to safe values via `createStateFromSave`.
      - Keep `CURRENT_SAVE_VERSION` unchanged.

    - Add at least one persistence test proving roundtrip compatibility:
      - Encode a state with therapist progress, decode it, and assert the therapist fields survive.
      - Decode a "pre-therapist" save payload (missing therapist fields) and assert defaults are applied.

    Follow existing test patterns from `tests/maison.unit.test.tsx`.
  </action>
  <verify>
    Run `pnpm run test:unit -- tests/therapist.unit.test.tsx`.
  </verify>
  <done>
    Therapist career behavior is covered by unit tests and save/load remains backward compatible.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm run typecheck`
- [ ] `pnpm run test:unit -- tests/therapist.unit.test.tsx`
- [ ] `pnpm run test:unit -- tests/maison.unit.test.tsx`
</verification>

<success_criteria>

- Therapist career progression exists and produces cash in a deterministic, testable way
- Save/load validates new fields and preserves backward compatibility
- Existing economy selectors and tests remain intact
  </success_criteria>

<output>
After completion, create `.planning/phases/14-therapist-career-economy/14-01-SUMMARY.md`:

# Phase 14 Plan 01 Summary

**[One-liner describing therapist career cash loop]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `src/game/state.ts` - [Description]
- `src/game/sim.ts` - [Description]
- `src/game/persistence.ts` - [Description]
- `tests/therapist.unit.test.tsx` - [Description]

## Decisions Made

[Selected option and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 14-02-PLAN.md
</output>
