---
phase: 12-major-updates-01-21
plan: 02
type: execute
---

<objective>
Introduce player settings storage and wire core gameplay toggles (theme mode, achievement filtering, tab visibility).

Purpose: Let players tailor the UI without destabilizing core mechanics.
Output: Persistent settings with UI behaviors and unit test coverage.
</objective>

<execution_context>
~/.config/opencode/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@NOTES.md
@.sisyphus/plans/notes-planned-features.md
@src/App.tsx
@src/style.css
@tests/catalog.unit.test.tsx
@tests/collection-loop.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add persistent settings state and Save tab controls</name>
  <files>src/App.tsx, tests/catalog.unit.test.tsx</files>
  <action>Create a settings model stored in localStorage key `emily-idle:settings` with fields: themeMode ("system" | "light" | "dark"), hideCompletedAchievements (boolean), hiddenTabs (array of tab ids). Follow the audio settings pattern for parsing and defensive defaults. Add Save tab controls to update these settings (theme select or radios, hide-completed checkbox, tab visibility checkboxes) with stable `data-testid` hooks. Add unit tests that verify defaults, invalid JSON fallbacks, and UI control wiring.</action>
  <verify>pnpm run test:unit -- --run tests/catalog.unit.test.tsx</verify>
  <done>Settings defaults are applied when storage is empty/invalid, and Save tab controls persist updates.</done>
</task>

<task type="auto">
  <name>Task 2: Apply theme mode to the document</name>
  <files>src/App.tsx, src/style.css</files>
  <action>Apply themeMode by setting a stable attribute or class on the document root (e.g., `data-theme="light"|"dark"|"system"`). Ensure existing styling continues to work and preserve `color-scheme` behavior. Update unit tests to confirm the attribute/class changes when the setting toggles.</action>
  <verify>pnpm run test:unit -- --run tests/catalog.unit.test.tsx</verify>
  <done>Theme mode toggles update the DOM attribute/class and tests confirm the behavior.</done>
</task>

<task type="auto">
  <name>Task 3: Wire settings to UI behaviors</name>
  <files>src/App.tsx, tests/catalog.unit.test.tsx, tests/collection-loop.spec.ts</files>
  <action>Use hideCompletedAchievements to filter the achievements list, and hiddenTabs to suppress unlocked tabs (except Vault/Save). If the active tab becomes hidden, fall back to Vault. Update unit tests and any affected e2e assertions so tab gating and achievements rendering remain stable.</action>
  <verify>pnpm run test:unit && pnpm run test:e2e -- --project=chromium --grep "tabs"</verify>
  <done>Hidden achievements and tab visibility settings apply consistently without breaking navigation or tests.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pnpm run test:unit`
- [ ] `pnpm run test:e2e`
- [ ] Manual check: toggling theme, achievements filter, and tab visibility behaves as expected
</verification>

<success_criteria>
- Settings persist via `emily-idle:settings` with safe defaults
- Theme mode toggles update the document root without breaking styles
- Achievements and tabs honor settings while preserving navigation
  </success_criteria>

<output>
After completion, create `.planning/phases/12-major-updates-01-21/12-02-SUMMARY.md`:

# Phase 12 Plan 02 Summary

**Added persistent settings and wired theme/visibility behaviors.**

## Accomplishments
- [ ] ...

## Files Created/Modified
- `src/App.tsx` - ...
- `src/style.css` - ...
- `tests/catalog.unit.test.tsx` - ...
- `tests/collection-loop.spec.ts` - ...

## Decisions Made
- None

## Issues Encountered
- None

## Next Step
- Ready for 12-03-PLAN.md
</output>
