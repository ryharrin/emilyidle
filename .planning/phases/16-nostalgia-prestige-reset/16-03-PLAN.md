---
phase: 16-nostalgia-prestige-reset
plan: 3
type: execute
wave: 3
depends_on: ["16-01", "16-02"]
files_modified:
  - tests/nostalgia-prestige.unit.test.tsx
  - tests/nostalgia-prestige.spec.ts
autonomous: true

must_haves:
  truths:
    - "Unit tests lock nostalgia gain semantics (0 below threshold, >=1 at threshold, monotonic)"
    - "Unit tests assert nostalgia prestige keeps owned watches but resets currencies and progression"
    - "E2E test covers the Nostalgia tab: progress/preview visible, confirmation modal, and post-reset results"
  artifacts:
    - path: "tests/nostalgia-prestige.unit.test.tsx"
      provides: "Unit coverage for nostalgia prestige helpers"
      contains: "describe(\"nostalgia prestige\""
    - path: "tests/nostalgia-prestige.spec.ts"
      provides: "Playwright coverage for nostalgia prestige UI flow"
      contains: "nostalgia-prestige"
  key_links:
    - from: "tests/nostalgia-prestige.spec.ts"
      to: "src/App.tsx"
      via: "data-testid hooks for modal/results"
      pattern: "nostalgia-(progress|preview|modal|results|prestige)"
---

<objective>
Add regression coverage for nostalgia prestige (logic + UI flow).

Purpose: Prevent accidental drift in reset semantics and ensure the new tab remains usable as the prestige design evolves.
Output: One unit test suite and one Playwright spec covering the full prestige flow.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/16-nostalgia-prestige-reset/16-CONTEXT.md
@.planning/phases/16-nostalgia-prestige-reset/16-01-SUMMARY.md
@.planning/phases/16-nostalgia-prestige-reset/16-02-SUMMARY.md

@src/game/state.ts
@src/game/sim.ts
@src/App.tsx
@tests/tabs.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unit tests for nostalgia gain and prestige reset semantics</name>
  <files>tests/nostalgia-prestige.unit.test.tsx</files>
  <action>
    Create `tests/nostalgia-prestige.unit.test.tsx` and cover the core invariants.

    Use `createInitialState()` and direct imports from `src/game/state.ts`.

    Required test cases:
    - Gain and eligibility:
      - With `nostalgiaEnjoymentEarnedCents = threshold - 1`, `getNostalgiaPrestigeGain` is 0 and `canNostalgiaPrestige`
        is false.
      - With `nostalgiaEnjoymentEarnedCents = threshold`, `getNostalgiaPrestigeGain` is >= 1 and `canNostalgiaPrestige`
        is true.
      - Monotonic check: pick two values `a < b` above threshold and assert `gain(b) >= gain(a)`.
    - Reset semantics:
      - Seed a state with:
        - non-zero `currencyCents`, `enjoymentCents`
        - owned watches in `items`
        - non-baseline `upgrades`, `workshopBlueprints`, `workshopUpgrades`, `maisonHeritage`, `therapistCareer`
        - `nostalgiaEnjoymentEarnedCents = threshold`
      - Call `prestigeNostalgia(state, nowMs)`.
      - Assert:
        - `nostalgiaPoints` increases by the computed gain
        - `nostalgiaResets` increments
        - `nostalgiaLastGain` is set and `nostalgiaLastPrestigedAtMs === nowMs`
        - `currencyCents === 0` and `enjoymentCents === 0`
        - `items` is unchanged (owned watches preserved)
        - `therapistCareer` resets to baseline
        - workshop/maison/crafting fields reset to baseline
        - `nostalgiaEnjoymentEarnedCents === 0`

    Keep assertions explicit; do not snapshot UI.
  </action>
  <verify>pnpm run test:unit</verify>
  <done>
    Unit tests fail if nostalgia gain or reset semantics change unintentionally.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add a Playwright test for the Nostalgia tab prestige flow</name>
  <files>tests/nostalgia-prestige.spec.ts</files>
  <action>
    Create a new Playwright spec that seeds an eligible save and runs through the prestige UI.

    Setup:
    - Use `page.addInitScript` to set `emily-idle:save` version 2 with a minimal state object that:
      - Has `currencyCents` and `enjoymentCents` non-zero (so reset is observable in UI).
      - Has `items` with at least one owned watch.
      - Sets `nostalgiaEnjoymentEarnedCents` to >= `getNostalgiaPrestigeThresholdCents()` (hardcode using a large value if
        you can't import the constant in the test).
      - Sets some progression fields non-baseline (e.g., `workshopBlueprints`, `maisonHeritage`, `therapistCareer.level`).
      - Omits any optional fields not required by save parsing (follow the pattern from `tests/tabs.spec.ts`).

    Flow assertions:
    1) `page.goto("/")`
    2) Click the "Nostalgia" tab.
    3) Assert the progress + preview are visible:
       - `data-testid=nostalgia-progress`
       - `data-testid=nostalgia-preview`
    4) Click the prestige CTA (`data-testid=nostalgia-prestige`).
    5) Assert the modal opens (`data-testid=nostalgia-modal`), then click Confirm.
    6) Assert results are shown (`data-testid=nostalgia-results`) and that the on-screen currency/enjoyment display reflects
       a reset (look at existing `#currency` / enjoyment display selectors used elsewhere).

    Keep copy assertions loose: do not match exact prose, prefer `data-testid` visibility and numeric changes.
  </action>
  <verify>pnpm run test:e2e</verify>
  <done>
    Playwright fails if the nostalgia tab flow (open -> confirm -> results) or the visible reset effect regresses.
  </done>
</task>

</tasks>

<verification>
- `pnpm run test:unit` passes
- `pnpm run test:e2e` passes
</verification>

<success_criteria>
- Unit and e2e coverage exists for nostalgia prestige and protects key loop semantics
</success_criteria>

<output>
After completion, create `.planning/phases/16-nostalgia-prestige-reset/16-03-SUMMARY.md`
</output>
