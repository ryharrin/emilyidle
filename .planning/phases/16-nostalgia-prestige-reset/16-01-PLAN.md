---
phase: 16-nostalgia-prestige-reset
plan: 1
type: execute
wave: 1
depends_on: []
files_modified:
  - src/game/state.ts
  - src/game/persistence.ts
  - src/game/sim.ts
autonomous: true

must_haves:
  truths:
    - "Nostalgia points are persisted in the save and survive reloads"
    - "Enjoyment earned since the last nostalgia prestige is tracked independently of current enjoyment balance"
    - "When eligible, nostalgia prestige awards at least 1 nostalgia point using a diminishing-returns function"
    - "Nostalgia prestige resets money/enjoyment and workshop/maison/career progression while keeping owned watches"
  artifacts:
    - path: "src/game/state.ts"
      provides: "Nostalgia state fields + prestige/reset helpers"
      exports:
        - "canNostalgiaPrestige"
        - "getNostalgiaPrestigeGain"
        - "getNostalgiaPrestigeThresholdCents"
        - "prestigeNostalgia"
      contains: "nostalgia"
    - path: "src/game/sim.ts"
      provides: "Accumulates enjoyment-earned counters during tick simulation"
      contains: "earnedEnjoyment"
    - path: "src/game/persistence.ts"
      provides: "Save/load round-trips nostalgia fields (backwards compatible)"
      contains: "sanitizeState"
  key_links:
    - from: "src/game/sim.ts"
      to: "src/game/state.ts"
      via: "mutates enjoyment-earned counters on each step"
      pattern: "enjoymentCents:.*\+.*earnedEnjoyment"
    - from: "src/game/persistence.ts"
      to: "src/game/state.ts"
      via: "createStateFromSave"
      pattern: "createStateFromSave\(persisted\)"
---

<objective>
Add the core nostalgia prestige data model and game logic (save-compatible).

Purpose: Establish the new top-level prestige layer so UI and tests can rely on stable, persisted semantics.
Output: New nostalgia fields in `GameState`, save/load support, and a `prestigeNostalgia(...)` reset function.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/16-nostalgia-prestige-reset/16-CONTEXT.md

@src/game/state.ts
@src/game/persistence.ts
@src/game/sim.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend GameState + save/load to include nostalgia fields (backwards compatible)</name>
  <files>
src/game/state.ts
src/game/persistence.ts
  </files>
  <action>
    Add new persisted fields required for nostalgia prestige.

    In `src/game/state.ts`:
    - Extend `GameState` with (names can vary slightly, but keep them stable and "nostalgia"-prefixed):
      - `nostalgiaPoints: number` (integer, non-negative)
      - `nostalgiaResets: number` (integer, non-negative)
      - `nostalgiaEnjoymentEarnedCents: number` (integer, non-negative; enjoyment earned since last nostalgia reset)
      - `nostalgiaLastGain: number` (integer, non-negative; used for results screen)
      - `nostalgiaLastPrestigedAtMs: number` (integer, non-negative; used for results screen)
    - Extend `PersistedGameState` with the same fields as optional entries.
    - Update `createInitialState()` to set sane defaults (all 0).
    - Update `createStateFromSave(saved)` to:
      - Accept missing fields (older saves) and default them to 0.
      - Clamp all nostalgia fields to integers >= 0.

    In `src/game/persistence.ts`:
    - Extend `sanitizeState(record)` to round-trip the nostalgia fields from the raw saved `record` into the constructed
      `PersistedGameState` (and thereby into `createStateFromSave`).
    - Ensure missing nostalgia fields do not invalidate the save (must remain optional so existing tests/saves continue to
      load).

    Notes:
    - Do NOT bump `CURRENT_SAVE_VERSION` (keep save v2). We are adding optional fields within the existing version.
    - Keep all new fields JSON-serializable primitives (numbers only).
  </action>
  <verify>pnpm run typecheck</verify>
  <done>
    New nostalgia fields exist in `GameState`, default correctly for new games, and load/save without breaking older saves.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement nostalgia eligibility + gain + prestige reset, and track enjoyment-earned per run</name>
  <files>
src/game/state.ts
src/game/sim.ts
  </files>
  <action>
    Implement the nostalgia prestige mechanics described in `16-CONTEXT.md`.

    In `src/game/state.ts`:
    1) Add exported threshold + gain helpers:
       - `export function getNostalgiaPrestigeThresholdCents(): number`
         - Choose a constant threshold (Claude discretion) that can be represented with a progress bar.
         - Use enjoyment units ("cents") consistent with the rest of the game.
       - `export function getNostalgiaPrestigeGain(state: GameState): number`
         - Compute gain from `state.nostalgiaEnjoymentEarnedCents`.
         - Use a diminishing-returns conversion (e.g., sqrt/log style) and keep it monotonic.
         - When `state.nostalgiaEnjoymentEarnedCents >= threshold`, gain MUST be at least 1.
         - When below threshold, gain MUST be 0.
       - `export function canNostalgiaPrestige(state: GameState): boolean`
         - Return true when `getNostalgiaPrestigeGain(state) > 0`.

    2) Add exported prestige action:
       - `export function prestigeNostalgia(state: GameState, nowMs: number): GameState`
       - Behavior (locked decisions):
         - Award `gain = getNostalgiaPrestigeGain(state)`; if gain is 0, return state unchanged.
         - Increment `nostalgiaPoints += gain`.
         - Increment `nostalgiaResets += 1`.
         - Set `nostalgiaLastGain = gain` and `nostalgiaLastPrestigedAtMs = nowMs`.
         - Reset currencies:
           - `currencyCents = 0`
           - `enjoymentCents = 0`
         - Keep owned watches across the reset:
           - `items` MUST remain unchanged.
         - Reset progression back to baseline:
           - `therapistCareer` to level 1 / xp 0 / nextAvailableAtMs 0.
           - `workshopBlueprints = 0`, `workshopPrestigeCount = 0`, `workshopUpgrades = createWorkshopUpgradeStates()`.
           - `maisonHeritage = 0`, `maisonReputation = 0`, `maisonUpgrades = createMaisonUpgradeStates()`,
             `maisonLines = createMaisonLineStates()`.
           - `eventStates = createEventStates()` (clear running events).
           - `craftingParts = 0` and `craftedBoosts` back to baseline zeros (treat these as workshop progression).
           - `upgrades = createUpgradeLevels()` (treat vault upgrades as run progression).
         - Reset the per-run enjoyment accumulator:
           - `nostalgiaEnjoymentEarnedCents = 0`.
         - Preserve long-lived discovery/achievements:
           - Keep `unlockedMilestones`, `achievementUnlocks`, `discoveredCatalogEntries`, `catalogTierUnlocks` unchanged.
         - Return the next state through `applyAchievementUnlocks(applyMilestoneUnlocks(nextState))` ONLY if needed
           for invariants; otherwise keep it a plain state update.

    In `src/game/sim.ts`:
    - When applying the normal tick income:
      - Continue to add to `state.enjoymentCents` as it currently does.
      - Also increment `state.nostalgiaEnjoymentEarnedCents` by the same per-tick earned enjoyment amount.
      - Clamp to integers (the sim already rounds via math; keep consistent behavior).
  </action>
  <verify>pnpm run test:unit</verify>
  <done>
    `prestigeNostalgia` exists and enforces the reset semantics; `nostalgiaEnjoymentEarnedCents` increases over time via
    simulation and resets to 0 when prestige triggers.
  </done>
</task>

</tasks>

<verification>
- `pnpm run typecheck` passes
- `pnpm run test:unit` passes
</verification>

<success_criteria>
- Save v2 loads with missing nostalgia fields, and new saves persist the fields
- Nostalgia gain is monotonic, diminishing-returns, and awards >= 1 point at eligibility
- Nostalgia prestige resets currencies + progression but keeps owned watches
</success_criteria>

<output>
After completion, create `.planning/phases/16-nostalgia-prestige-reset/16-01-SUMMARY.md`
</output>
