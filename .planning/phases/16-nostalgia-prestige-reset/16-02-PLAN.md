---
phase: 16-nostalgia-prestige-reset
plan: 2
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/App.tsx
  - src/style.css
autonomous: true

must_haves:
  truths:
    - "A new Nostalgia tab appears when the player is close to eligibility or has prestiged at least once"
    - "The Nostalgia tab shows a progress bar toward eligibility and a preview of nostalgia gain"
    - "Prestiging requires a confirmation modal and, once confirmed, shows a results screen"
    - "Prestiging is disabled when ineligible and does not require leaving the tab"
  artifacts:
    - path: "src/App.tsx"
      provides: "Nostalgia tab UI + confirmation modal + results rendering"
      contains: "data-testid=\"nostalgia-"
    - path: "src/style.css"
      provides: "Progress bar + modal styling for nostalgia UI"
      contains: ".nostalgia"
  key_links:
    - from: "src/App.tsx"
      to: "src/game/state.ts"
      via: "prestige helpers for preview and reset"
      pattern: "getNostalgiaPrestigeGain\(|prestigeNostalgia\("
---

<objective>
Add the Nostalgia/Prestige UI: eligibility progress, reward preview, confirmation, and results.

Purpose: Make the new nostalgia prestige loop legible and safe to trigger.
Output: A new top-level tab with a single confirmation modal and a post-reset results view.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/16-nostalgia-prestige-reset/16-CONTEXT.md
@.planning/phases/16-nostalgia-prestige-reset/16-01-SUMMARY.md

@src/App.tsx
@src/style.css
@src/game/state.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Nostalgia tab with eligibility progress + reward preview</name>
  <files>src/App.tsx</files>
  <action>
    Add a new top-level tab and tabpanel for nostalgia prestige.

    Tab plumbing:
    - In `TAB_DEFINITIONS`, add `{ id: "nostalgia", label: "Nostalgia" }` between "maison" and "catalog".
    - Update `TabId` typing implicitly via `TAB_DEFINITIONS`.
    - Update tab visibility maps (`tabVisibility`, `combinedTabVisibility`) to include `nostalgia`.

    Visibility gating (locked decision: gated behind a threshold, with a teaser):
    - The nostalgia tab should be visible when either is true:
      - The player has any nostalgia points (`state.nostalgiaPoints > 0`) OR
      - They are close to eligibility (teaser), using an 80% reveal rule similar to Workshop/Maison.
    - Implement teaser based on the ratio:
      - `state.nostalgiaEnjoymentEarnedCents / getNostalgiaPrestigeThresholdCents()`.
    - Keep the tab hidden on early fresh saves.

    In the new `<section id="nostalgia" ...>`:
    - Compute:
      - `const threshold = getNostalgiaPrestigeThresholdCents()`
      - `const earned = state.nostalgiaEnjoymentEarnedCents`
      - `const progress = Math.min(1, earned / threshold)`
      - `const gain = getNostalgiaPrestigeGain(state)`
      - `const eligible = canNostalgiaPrestige(state)`
    - Render a panel that contains:
      - A short description of what prestige does.
      - A progress bar (`data-testid="nostalgia-progress"`) with a visible percent label and a numeric
        `earned / threshold` line (use `getEnjoymentThresholdLabel(threshold)` for the threshold label).
      - A preview block (`data-testid="nostalgia-preview"`) showing projected gain and current nostalgia points.
      - Two explicit lists:
        - "Resets" (money, enjoyment, workshop/maison/career, upgrades/boosts)
        - "Keeps" (owned watches, discoveries/achievements)
      - A primary CTA button (`data-testid="nostalgia-prestige"`) disabled when `!eligible`.

    Test hooks (keep stable):
    - Add `data-testid="nostalgia-tab"` on the tab button OR rely on role+name; still add at least one stable
      `data-testid` within the tabpanel for tests.
  </action>
  <verify>pnpm run typecheck</verify>
  <done>
    Nostalgia tab appears only when reveal-ready or after first prestige, and renders progress + gain preview with stable
    test ids.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add confirmation modal + post-prestige results screen</name>
  <files>
src/App.tsx
src/style.css
  </files>
  <action>
    Implement the required single confirmation modal and results view.

    In `src/App.tsx`:
    - Add local UI state for the modal open/closed (e.g., `nostalgiaModalOpen`).
    - Clicking the CTA opens the modal.
    - Modal requirements:
      - Use a single modal (not the two-step inline fieldset pattern used by Workshop/Maison).
      - Include:
        - projected nostalgia gain
        - a short "this will reset" recap
      - Buttons:
        - Confirm: calls `handlePurchase(prestigeNostalgia(state, Date.now()))` and closes the modal.
        - Cancel: closes the modal.
      - Add `data-testid="nostalgia-modal"` on the modal container.

    Results screen requirements:
    - After a prestige, show a results panel when `state.nostalgiaLastGain > 0`:
      - `data-testid="nostalgia-results"`
      - Display gained nostalgia, new total points, and a clear "reset complete" message.
      - Optionally include a timestamp based on `nostalgiaLastPrestigedAtMs`.
    - Provide a small "Continue" / "Back to progress" button that clears the results view (UI-only state) OR keep it
      always visible until the next prestige; either is acceptable, but the UI must not be confusing.

    In `src/style.css`:
    - Add minimal, localized styling:
      - `.nostalgia-progress` (track + fill)
      - `.nostalgia-modal` (overlay + centered panel)
      - `.nostalgia-results` (highlighted result card)
    - Keep class names stable and scoped ("nostalgia"-prefixed).
    - Avoid broad global CSS churn.
  </action>
  <verify>pnpm run lint</verify>
  <done>
    Clicking prestige opens a modal; confirming performs the reset and shows a results screen with stable test ids.
  </done>
</task>

</tasks>

<verification>
- `pnpm run typecheck` passes
- `pnpm run lint` passes
</verification>

<success_criteria>
- Nostalgia tab communicates eligibility, reward preview, and what resets vs persists
- Prestige confirmation uses a single modal and cannot be triggered accidentally
- Results view is shown immediately after prestige and is test-addressable via `data-testid`
</success_criteria>

<output>
After completion, create `.planning/phases/16-nostalgia-prestige-reset/16-02-SUMMARY.md`
</output>
