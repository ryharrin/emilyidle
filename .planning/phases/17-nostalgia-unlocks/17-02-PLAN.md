---
phase: 17-nostalgia-unlocks
plan: 2
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - src/App.tsx
  - src/style.css
autonomous: true

must_haves:
  truths:
    - "Player can see an Unlocks store in the Nostalgia tab with clear disabled states"
    - "Player can buy the next available unlock (classic -> chronograph -> tourbillon) and see nostalgia points update"
    - "Player can refund the most recent unlock for a full nostalgia refund"
  artifacts:
    - path: src/App.tsx
      provides: "Nostalgia tab unlock store UI + confirmation toggle + stable test ids"
    - path: src/style.css
      provides: "Unlock store card grid styling consistent with existing Nostalgia panel"
  key_links:
    - from: src/App.tsx
      to: src/game/state.ts
      via: buyNostalgiaUnlock/refundNostalgiaUnlock
      pattern: "buyNostalgiaUnlock\(|refundNostalgiaUnlock\("
    - from: src/App.tsx
      to: src/App.tsx
      via: persistSettings
      pattern: "confirmNostalgiaUnlocks"
---

<objective>
Extend the existing Nostalgia tab with an always-visible unlock store UI to buy/refund nostalgia unlocks, with an optional confirmation toggle (default ON).

Purpose: Let players spend nostalgia points on permanent watch unlocks and respec when desired.
Output: Nostalgia Unlocks panel UI + styles + stable test hooks.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/17-nostalgia-unlocks/17-CONTEXT.md

@src/App.tsx
@src/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add a local settings toggle for nostalgia unlock confirmations (default ON)</name>
  <files>src/App.tsx</files>
  <action>
In `src/App.tsx`, extend the existing localStorage-backed `Settings` model:
- Add `confirmNostalgiaUnlocks: boolean` to the `Settings` type.
- Set `DEFAULT_SETTINGS.confirmNostalgiaUnlocks = true`.
- In `loadSettings()`, parse `confirmNostalgiaUnlocks` from JSON only when it is a boolean; otherwise default to true.
- Ensure `persistSettings(...)` writes the updated settings shape.

This setting must be stored in `emily-idle:settings` (NOT the save payload) to match existing settings behavior.
  </action>
  <verify>pnpm run typecheck</verify>
  <done>
App loads/saves `confirmNostalgiaUnlocks` via localStorage settings and defaults to ON when missing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement the Nostalgia unlock store UI (cards + buy/refund + optional confirmation)</name>
  <files>src/App.tsx, src/style.css</files>
  <action>
In `src/App.tsx`, extend the existing Nostalgia panel (the branch where `showNostalgiaPanel` is true) by adding an Unlocks section:

- Import and use the domain helpers from `src/game/state.ts`:
  - `getNostalgiaUnlockIds`, `getNostalgiaUnlockCost`
  - `canBuyNostalgiaUnlock`, `buyNostalgiaUnlock`
  - `canRefundNostalgiaUnlock`, `refundNostalgiaUnlock`

- Render an always-visible unlock store section under the existing prestige UI:
  - Wrapper: `data-testid="nostalgia-unlocks"`.
  - Card grid: one card per unlockable watch id in definition/order.
  - Each card should show: watch name, short description (re-use watch definition text), cost in nostalgia, and current status (Unlocked / Locked).
  - Disabled states:
    - If `state.nostalgiaResets < 1`, keep cards visible but disable buy actions and show a clear message like "Complete your first Nostalgia prestige to start unlocking.".
    - If order prereq not met, disable buy and show a message like "Unlock Classic first".
    - If insufficient nostalgia points, disable buy and show "Need X more Nostalgia".

- Buttons + stable test ids (new ids only; do NOT change any existing `nostalgia-*` ids used by Phase 16 tests):
  - Card: `data-testid={\`nostalgia-unlock-card-${id}\`}`
  - Buy: `data-testid={\`nostalgia-unlock-buy-${id}\`}`
  - Refund: `data-testid={\`nostalgia-unlock-refund-${id}\`}`
  - Settings toggle: `data-testid="nostalgia-unlock-confirm-toggle"`
  - Confirmation modal: `data-testid="nostalgia-unlock-modal"`

- Confirmation behavior:
  - Add a toggle UI (checkbox or switch) near the unlock store header: "Confirm unlock purchases".
  - When `settings.confirmNostalgiaUnlocks` is true, clicking Buy opens a modal asking to confirm spending {cost} Nostalgia to unlock {watchName}.
  - When false, buying applies immediately.
  - Refunds may apply immediately (no confirmation required) unless you choose to reuse the modal for refunds.

- UI behavior requirements:
  - Buying/refunding must call `handlePurchase(...)` with the result of `buyNostalgiaUnlock(...)` / `refundNostalgiaUnlock(...)`.
  - Show the updated Nostalgia balance in the existing `data-testid="nostalgia-balance"` header automatically (no new balance widget).

In `src/style.css`, add minimal styles for the unlock store that match existing `card` / `card-stack` patterns:
- A responsive grid for unlock cards (similar density to other card grids).
- A subtle “Unlocked” badge/state.
- Disabled button/copy should remain readable in both themes.
  </action>
  <verify>pnpm run typecheck</verify>
  <done>
Unlock store is visible in the Nostalgia panel, supports buy + refund flows, and respects confirmation toggle and order/affordability disabled states.
  </done>
</task>

</tasks>

<verification>
- `pnpm run typecheck`
</verification>

<success_criteria>
- Unlock store renders for all players who can see the Nostalgia panel, and uses stable new `data-testid` hooks.
- Buying and refunding unlocks updates `state.nostalgiaPoints` and the UI reflects the new status immediately.
</success_criteria>

<output>
After completion, create `.planning/phases/17-nostalgia-unlocks/17-02-SUMMARY.md`
</output>
