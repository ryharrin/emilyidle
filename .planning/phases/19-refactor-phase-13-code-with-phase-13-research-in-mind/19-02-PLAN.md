---
phase: 19-refactor-phase-13-code-with-phase-13-research-in-mind
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - tests/enjoyment.unit.test.tsx
  - tests/purchase-gates.unit.test.tsx
autonomous: true

must_haves:
  truths:
    - "Prestige legacy multiplier affects enjoyment/sec (not just cash/sec)"
    - "Watch purchase gating still enforces enjoyment thresholds and reports deficits"
  artifacts:
    - path: "tests/enjoyment.unit.test.tsx"
      provides: "Unit coverage for prestige-scaled enjoyment"
    - path: "tests/purchase-gates.unit.test.tsx"
      provides: "Unit coverage for enjoyment/cash purchase gating"
  key_links:
    - from: "tests/enjoyment.unit.test.tsx"
      to: "getEnjoymentRateCentsPerSec"
      via: "import from src/game/state"
      pattern: "getEnjoymentRateCentsPerSec"
    - from: "tests/purchase-gates.unit.test.tsx"
      to: "getWatchPurchaseGate"
      via: "import from src/game/state"
      pattern: "getWatchPurchaseGate"
---

<objective>
Add targeted unit coverage that encodes Phase 13's research-informed invariants (per-watch enjoyment, prestige scaling, and meaningful gating), so refactors don't accidentally regress the enjoyment economy.

Purpose: Lock in Phase 13 behaviors with tests, reducing refactor risk.
Output: Unit tests that fail loudly if enjoyment scaling/gating breaks.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/13-enjoyment-economy-foundation/13-RESEARCH.md
@.planning/phases/13-enjoyment-economy-foundation/13-01-SUMMARY.md
@.planning/phases/15-dual-currency-acquisition/15-01-SUMMARY.md

@tests/enjoyment.unit.test.tsx
@src/game/selectors/index.ts
@src/game/actions/index.ts
@src/game/data/items.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unit tests for prestige-scaled enjoyment</name>
  <files>tests/enjoyment.unit.test.tsx</files>
  <action>
- Extend `tests/enjoyment.unit.test.tsx` with a new test that proves `getEnjoymentRateCentsPerSec` scales by the prestige legacy multiplier.
- Construct a state with:
  - at least one owned watch
  - a non-zero prestige legacy multiplier (e.g. `workshopPrestigeCount` and/or `maisonHeritage` > 0)
- Assert the enjoyment rate equals `baseRate * getPrestigeLegacyMultiplier(state)` (within exact numeric equality if the current implementation remains integer-safe; otherwise use a small epsilon).
  </action>
  <verify>pnpm run test:unit -- --run tests/enjoyment.unit.test.tsx</verify>
  <done>
- A new test fails if prestige legacy scaling is removed from enjoyment.
- The test passes on current behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for enjoyment/cash purchase gating</name>
  <files>tests/purchase-gates.unit.test.tsx</files>
  <action>
- Create `tests/purchase-gates.unit.test.tsx` following existing Vitest conventions.
- Add at least two cases covering `getWatchPurchaseGate(state, id, quantity)`:
  - Case A: blocks by enjoyment when `state.enjoymentCents` is below `WATCH_ENJOYMENT_REQUIREMENTS_CENTS[id]`.
  - Case B: blocks by cash when enjoyment is satisfied but `state.currencyCents` is below price.
- Assert:
  - `ok` is false
  - `blocksBy` matches expected
  - deficit fields (`enjoymentDeficitCents` / `cashDeficitCents`) are present and correct.
  </action>
  <verify>pnpm run test:unit -- --run tests/purchase-gates.unit.test.tsx</verify>
  <done>
- New tests encode the enjoyment-first gating behavior and fail if gating semantics regress.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run unit suite to confirm no collateral regressions</name>
  <files>
tests/enjoyment.unit.test.tsx
tests/purchase-gates.unit.test.tsx
  </files>
  <action>
- Run the full unit test suite and fix any issues introduced by the new tests.
  </action>
  <verify>pnpm run test:unit</verify>
  <done>
- `pnpm run test:unit` passes.
  </done>
</task>

</tasks>

<verification>
- `pnpm run test:unit` passes
</verification>

<success_criteria>
- Unit tests exist for prestige-scaled enjoyment rate and enjoyment/cash purchase gating.
- Future refactors that break Phase 13 behavior are caught by CI.
</success_criteria>

<output>
After completion, create `.planning/phases/19-refactor-phase-13-code-with-phase-13-research-in-mind/19-02-SUMMARY.md`
</output>
