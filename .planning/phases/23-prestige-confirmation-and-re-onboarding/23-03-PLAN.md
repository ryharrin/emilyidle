---
phase: 23-prestige-confirmation-and-re-onboarding
plan: 03
type: execute
wave: 3
depends_on:
  - 23-02
files_modified:
  - src/App.tsx
  - src/ui/prestigeOnboarding.ts
  - src/ui/components/PrestigeOnboardingModal.tsx
  - tests/prestige-onboarding.unit.test.ts
  - tests/prestige-confirmation.spec.ts
  - tests/nostalgia-prestige.spec.ts
autonomous: true

must_haves:
  truths:
    - "Immediately after any prestige, user sees a re-onboarding summary and a recommended next action"
    - "User can close the re-onboarding surface and continue play without losing context"
    - "Backing out of prestige leaves currency/enjoyment untouched"
  artifacts:
    - path: "src/ui/components/PrestigeOnboardingModal.tsx"
      provides: "post-prestige re-onboarding modal (UI-only)"
    - path: "src/ui/prestigeOnboarding.ts"
      provides: "prestige detection + recommended next-action mapping"
    - path: "tests/prestige-confirmation.spec.ts"
      provides: "e2e coverage for Atelier + Maison back-out + post-prestige guidance"
    - path: "tests/nostalgia-prestige.spec.ts"
      provides: "nostalgia back-out + onboarding coverage"
  key_links:
    - from: "src/App.tsx"
      to: "src/ui/prestigeOnboarding.ts"
      via: "detect prestige from prev/next state"
      pattern: "detectPrestigeEvent\(prev, next\)"
    - from: "src/ui/components/PrestigeOnboardingModal.tsx"
      to: "src/ui/prestigeOnboarding.ts"
      via: "content derived from getPrestigeOnboardingContent"
      pattern: "getPrestigeOnboardingContent\(prestigeOnboarding\)"
    - from: "tests/prestige-confirmation.spec.ts"
      to: "src/App.tsx"
      via: "Playwright assertions"
      pattern: "prestige-onboarding-modal"
---

<objective>
Add a post-prestige re-onboarding surface that appears immediately after a reset and provides a clear recommended next action, plus end-to-end coverage for safe back-out.

Purpose: Satisfies PRES-02 by helping players re-orient after a reset, while proving PRES-01's safe back-out via Playwright.
Output: UI-only onboarding modal driven from `App.tsx` purchase transitions + Playwright tests.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-prestige-confirmation-and-re-onboarding/23-RESEARCH.md

@src/App.tsx
@src/ui/tabs/WorkshopTab.tsx
@src/ui/tabs/MaisonTab.tsx
@src/ui/tabs/NostalgiaTab.tsx
@tests/nostalgia-prestige.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add prestige detection + onboarding copy mapping</name>
  <files>src/ui/prestigeOnboarding.ts
tests/prestige-onboarding.unit.test.ts</files>
  <action>
Create `src/ui/prestigeOnboarding.ts` exporting:
- `type PrestigeEvent = { tier: "workshop" | "maison" | "nostalgia"; gained: Record<string, number>; occurredAtMs: number }`.
- `detectPrestigeEvent(prev: GameState, next: GameState, nowMs: number, prestigeTierOverride?: PrestigeEvent["tier"]): PrestigeEvent | null`.
  - If `prestigeTierOverride` is provided, use it to select the tier and compute gains from `prev`/`next` (no heuristics).
    - workshop gain: `next.workshopBlueprints - prev.workshopBlueprints`
    - maison gain: `next.maisonHeritage - prev.maisonHeritage` and `next.maisonReputation - prev.maisonReputation`
    - nostalgia gain: `next.nostalgiaLastGain` (fallback to `next.nostalgiaPoints - prev.nostalgiaPoints`)
  - Otherwise, fall back to action-driven signals:
    - Workshop: `next.workshopPrestigeCount === prev.workshopPrestigeCount + 1` and gained = `{ blueprints: next.workshopBlueprints - prev.workshopBlueprints }`.
    - Nostalgia: `next.nostalgiaResets === prev.nostalgiaResets + 1` and gained = `{ nostalgia: next.nostalgiaLastGain }` (fallback to delta in `nostalgiaPoints` if needed).
    - Maison is override-only (must pass `prestigeTierOverride: "maison"`).
- `getPrestigeOnboardingContent(event: PrestigeEvent): { title: string; body: string; recommended: { label: string; tabId: "collection" | "workshop" | "maison" | "nostalgia" } }`.

Copy requirements:
- Include the gained currency in the body.
- Provide exactly one recommended next action (single CTA) that makes sense per tier:
  - Workshop: "Spend your Blueprints on an Atelier upgrade" (tabId: "workshop").
  - Maison: "Return to Vault and rebuild enjoyment for the next legacy" (tabId: "collection").
  - Nostalgia: "Visit the Unlock store to spend Nostalgia" (tabId: "nostalgia").

Add `tests/prestige-onboarding.unit.test.ts` with Vitest coverage:
- `detectPrestigeEvent` returns the correct tier + gains for workshop/maison/nostalgia transitions.
- Non-prestige changes to heritage/reputation do not trigger a Maison prestige event.
- `getPrestigeOnboardingContent` always returns exactly one recommended CTA.
  </action>
  <verify>pnpm run test:unit -- tests/prestige-onboarding.unit.test.ts</verify>
  <done>`detectPrestigeEvent` reliably identifies the three prestige transitions without adding persistence.</done>
</task>

<task type="auto">
  <name>Task 2: Render a global post-prestige onboarding modal from App</name>
  <files>
src/App.tsx
src/ui/components/PrestigeOnboardingModal.tsx
  </files>
  <action>
Create `src/ui/components/PrestigeOnboardingModal.tsx`:
- Render a modal overlay using the existing modal styling pattern (reuse `.nostalgia-modal` / `.nostalgia-modal-card` classes).
- Add `data-testid="prestige-onboarding-modal"` on the overlay.
- Include:
  - Title text.
  - Body text with gained currency.
  - A primary button for the recommended action.
  - A secondary "Close" button.

Wire it into `src/App.tsx`:
- Add UI-only state: `const [prestigeOnboarding, setPrestigeOnboarding] = useState<PrestigeEvent | null>(null);`
- Extend the `onPurchase`/`handlePurchase` signature to accept optional metadata `{ prestigeTier?: PrestigeEvent["tier"] }`.
- In `handlePurchase`, when applying a new state, compute `detectPrestigeEvent(state, nextState, Date.now(), meta?.prestigeTier)` before overwriting `state` and, if present, set `prestigeOnboarding`.
- The authoritative hook is the `onPurchase` handler in `src/App.tsx` that applies nextState from `prestigeWorkshop`, `prestigeMaison`, and `prestigeNostalgia`; ensure all three tiers pass `prestigeTier` metadata and route through the same detection call.
- Use `getPrestigeOnboardingContent(prestigeOnboarding)` to populate the modal `title`, `body`, and recommended CTA.
- When the modal's recommended action is clicked, set `activeTab` to the recommended `tabId` and close the modal.
- Close button only dismisses the modal.

Nostalgia coexistence rule:
- Keep the existing `nostalgia-results` card behavior intact; the onboarding modal can appear on top, and the results card should still be visible after closing the modal.

Keep behavior stable in tests:
- Do not depend on timers/animations.
- Prefer role/testid selectors.
  </action>
  <verify>pnpm run typecheck</verify>
  <done>After any prestige, the onboarding modal appears and can navigate to the recommended tab.</done>
</task>

<task type="auto">
  <name>Task 3: Add Playwright coverage for back-out + onboarding (Atelier/Maison/Nostalgia)</name>
  <files>
tests/prestige-confirmation.spec.ts
tests/nostalgia-prestige.spec.ts
  </files>
  <action>
Add a new Playwright spec `tests/prestige-confirmation.spec.ts` that seeds a save state and verifies:

- Use the existing seeding pattern from `tests/nostalgia-prestige.spec.ts`:
  - `page.addInitScript` to write `emily-idle:save` to localStorage
  - Payload shape `{ version: 2, savedAt, lastSimulatedAtMs, state }`

Atelier back-out + confirm:
1) Navigate to `Atelier`.
2) Click `Reset atelier` to arm.
3) Assert `workshop-prestige-summary` is visible.
4) Capture `#currency` and `#enjoyment` text values.
5) Click `Cancel` and assert both values are unchanged.
5) Re-arm and click `Confirm reset`.
6) Assert `data-testid="prestige-onboarding-modal"` appears and `#currency`/`#enjoyment` show `$0`.

Maison back-out + confirm:
1) Navigate to `Maison`.
2) Click `Prestige atelier` to arm.
3) Assert `maison-prestige-summary` is visible.
4) Capture `#currency` and `#enjoyment` values, Cancel, and assert both are unchanged.
5) Confirm and assert onboarding modal appears.

Update `tests/nostalgia-prestige.spec.ts`:
- Add a back-out step: open nostalgia modal, click Cancel, assert stats unchanged.
- Capture `#currency`/`#enjoyment` before Cancel and assert unchanged after.
- Assert `data-testid="nostalgia-prestige-summary"` is visible in the panel or modal before confirming.
- After confirming nostalgia prestige, assert onboarding modal appears; close it and confirm `nostalgia-results` remains visible.

Keep selectors stable (use roles + data-testid).
  </action>
  <verify>pnpm run test:e2e</verify>
  <done>Playwright passes and proves: cancel does not reset; confirm resets and shows a recommended next action.</done>
</task>

</tasks>

<verification>
- `pnpm run typecheck`
- `pnpm run test:unit`
- `pnpm run test:e2e`
</verification>

<success_criteria>
- After any prestige (Atelier/Maison/Nostalgia), an onboarding modal appears with a single recommended next action.
- Player can back out of prestige without committing the reset (Playwright-verified).
</success_criteria>

<output>
After completion, create `.planning/phases/23-prestige-confirmation-and-re-onboarding/23-03-SUMMARY.md`
</output>
