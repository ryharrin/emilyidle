---
phase: 23-prestige-confirmation-and-re-onboarding
plan: 03
type: execute
wave: 3
depends_on:
  - 23-02
files_modified:
  - src/App.tsx
  - src/ui/prestigeOnboarding.ts
  - src/ui/components/PrestigeOnboardingModal.tsx
  - tests/prestige-confirmation.spec.ts
  - tests/nostalgia-prestige.spec.ts
autonomous: true

must_haves:
  truths:
    - "Immediately after any prestige, user sees a re-onboarding summary and a recommended next action"
    - "User can close the re-onboarding surface and continue play without losing context"
    - "Backing out of prestige leaves currency/enjoyment untouched"
  artifacts:
    - path: "src/ui/components/PrestigeOnboardingModal.tsx"
      provides: "post-prestige re-onboarding modal (UI-only)"
    - path: "src/ui/prestigeOnboarding.ts"
      provides: "prestige detection + recommended next-action mapping"
    - path: "tests/prestige-confirmation.spec.ts"
      provides: "e2e coverage for Atelier + Maison back-out + post-prestige guidance"
  key_links:
    - from: "src/App.tsx"
      to: "src/ui/prestigeOnboarding.ts"
      via: "detect prestige from prev/next state"
      pattern: "detectPrestigeEvent\(prev, next\)"
    - from: "tests/prestige-confirmation.spec.ts"
      to: "src/App.tsx"
      via: "Playwright assertions"
      pattern: "prestige-onboarding"
---

<objective>
Add a post-prestige re-onboarding surface that appears immediately after a reset and provides a clear recommended next action, plus end-to-end coverage for safe back-out.

Purpose: Satisfies PRES-02 by helping players re-orient after a reset, while proving PRES-01's safe back-out via Playwright.
Output: UI-only onboarding modal driven from `App.tsx` purchase transitions + Playwright tests.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-prestige-confirmation-and-re-onboarding/23-RESEARCH.md

@src/App.tsx
@src/ui/tabs/WorkshopTab.tsx
@src/ui/tabs/MaisonTab.tsx
@src/ui/tabs/NostalgiaTab.tsx
@tests/nostalgia-prestige.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add prestige detection + onboarding copy mapping</name>
  <files>src/ui/prestigeOnboarding.ts</files>
  <action>
Create `src/ui/prestigeOnboarding.ts` exporting:
- `type PrestigeEvent = { tier: "workshop" | "maison" | "nostalgia"; gained: Record<string, number>; occurredAtMs: number }`.
- `detectPrestigeEvent(prev: GameState, next: GameState, nowMs: number): PrestigeEvent | null` using the action-driven signals:
  - Workshop: `next.workshopPrestigeCount === prev.workshopPrestigeCount + 1` and gained = `{ blueprints: next.workshopBlueprints - prev.workshopBlueprints }`.
  - Maison: `next.maisonHeritage > prev.maisonHeritage || next.maisonReputation > prev.maisonReputation` and gained = `{ heritage: deltaHeritage, reputation: deltaReputation }`.
  - Nostalgia: `next.nostalgiaResets === prev.nostalgiaResets + 1` and gained = `{ nostalgia: next.nostalgiaLastGain }` (fallback to delta in `nostalgiaPoints` if needed).
- `getPrestigeOnboardingContent(event: PrestigeEvent): { title: string; body: string; recommended: { label: string; tabId: "collection" | "workshop" | "maison" | "nostalgia" } }`.

Copy requirements:
- Include the gained currency in the body.
- Provide exactly one recommended next action (single CTA) that makes sense per tier:
  - Workshop: "Spend your Blueprints on an Atelier upgrade" (tabId: "workshop").
  - Maison: "Return to Vault and rebuild enjoyment for the next legacy" (tabId: "collection").
  - Nostalgia: "Visit the Unlock store to spend Nostalgia" (tabId: "nostalgia").
  </action>
  <verify>pnpm run typecheck</verify>
  <done>`detectPrestigeEvent` reliably identifies the three prestige transitions without adding persistence.</done>
</task>

<task type="auto">
  <name>Task 2: Render a global post-prestige onboarding modal from App</name>
  <files>
src/App.tsx
src/ui/components/PrestigeOnboardingModal.tsx
  </files>
  <action>
Create `src/ui/components/PrestigeOnboardingModal.tsx`:
- Render a modal overlay using the existing modal styling pattern (reuse `.nostalgia-modal` / `.nostalgia-modal-card` classes).
- Add `data-testid="prestige-onboarding-modal"` on the overlay.
- Include:
  - Title text.
  - Body text with gained currency.
  - A primary button for the recommended action.
  - A secondary "Close" button.

Wire it into `src/App.tsx`:
- Add UI-only state: `const [prestigeOnboarding, setPrestigeOnboarding] = useState<PrestigeEvent | null>(null);`
- In `handlePurchase`, when applying a new state, compute `detectPrestigeEvent(state, nextState, Date.now())` before overwriting `state` and, if present, set `prestigeOnboarding`.
- When the modal's recommended action is clicked, set `activeTab` to the recommended `tabId` and close the modal.
- Close button only dismisses the modal.

Keep behavior stable in tests:
- Do not depend on timers/animations.
- Prefer role/testid selectors.
  </action>
  <verify>pnpm run typecheck</verify>
  <done>After any prestige, the onboarding modal appears and can navigate to the recommended tab.</done>
</task>

<task type="auto">
  <name>Task 3: Add Playwright coverage for back-out + onboarding (Atelier/Maison/Nostalgia)</name>
  <files>
tests/prestige-confirmation.spec.ts
tests/nostalgia-prestige.spec.ts
  </files>
  <action>
Add a new Playwright spec `tests/prestige-confirmation.spec.ts` that seeds a save state and verifies:

Atelier back-out + confirm:
1) Navigate to `Atelier`.
2) Click `Reset atelier` to arm.
3) Assert `workshop-prestige-summary` is visible.
4) Click `Cancel` and assert `#currency` and `#enjoyment` are NOT reset to `$0`.
5) Re-arm and click `Confirm reset`.
6) Assert `data-testid="prestige-onboarding-modal"` appears and `#currency`/`#enjoyment` show `$0`.

Maison back-out + confirm:
1) Navigate to `Maison`.
2) Click `Prestige atelier` to arm.
3) Assert `maison-prestige-summary` is visible.
4) Cancel and assert stats unchanged.
5) Confirm and assert onboarding modal appears.

Update `tests/nostalgia-prestige.spec.ts`:
- Add a back-out step: open nostalgia modal, click Cancel, assert stats unchanged.
- After confirming nostalgia prestige, assert onboarding modal appears.

Keep selectors stable (use roles + data-testid).
  </action>
  <verify>pnpm run test:e2e</verify>
  <done>Playwright passes and proves: cancel does not reset; confirm resets and shows a recommended next action.</done>
</task>

</tasks>

<verification>
- `pnpm run typecheck`
- `pnpm run test:unit`
- `pnpm run test:e2e`
</verification>

<success_criteria>
- After any prestige (Atelier/Maison/Nostalgia), an onboarding modal appears with a single recommended next action.
- Player can back out of prestige without committing the reset (Playwright-verified).
</success_criteria>

<output>
After completion, create `.planning/phases/23-prestige-confirmation-and-re-onboarding/23-03-SUMMARY.md`
</output>
