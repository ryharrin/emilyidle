---
phase: 18-codebase-refactor
plan: 7
type: execute
wave: 6
depends_on: ["18-06", "18-09", "18-10"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "All required automated gates pass (lint/typecheck/unit/e2e/build)"
    - "Refactor does not break persistence contracts or Playwright selector contracts"
    - "Player can load an existing save (or start fresh) and reach the Collection tab without crashes (verified via Playwright)"
  artifacts:
    - path: "tests/collection-loop.spec.ts"
      provides: "E2E coverage for autosave + vault loop selectors"
    - path: "tests/tabs.spec.ts"
      provides: "E2E coverage for tab visibility + aria/role contracts"
    - path: "tests/nostalgia-prestige.spec.ts"
      provides: "E2E coverage for nostalgia prestige flow"
  key_links:
    - from: "src/ui/tabs"
      to: "tests/*.spec.ts"
      via: "id/data-testid selectors"
      pattern: "data-testid=\"(workshop-panel|maison-panel|catalog-grid|nostalgia-progress)\""
---

<objective>
Run the full automated verification suite after the refactor and fix any regressions without expanding scope.

Purpose: Confirm the refactor is shippable before manual smoke testing.
Output: Green lint/typecheck/unit/e2e/build gates (CI-equivalent).
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/18-codebase-refactor/18-CONTEXT.md
@.planning/phases/18-codebase-refactor/18-RESEARCH.md

@src/App.tsx
@src/game/state.ts
@tests/tabs.spec.ts
@tests/collection-loop.spec.ts
@tests/nostalgia-prestige.spec.ts
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Phase 18 refactor changes with lint/typecheck/unit/e2e/build gates</what-built>
  <how-to-verify>
1. Run `pnpm run lint`.
2. Run `pnpm run typecheck`.
3. Run `pnpm run test:unit`.
4. Run `pnpm run test:e2e`.
5. Run `pnpm run build`.
6. If any command fails, stop and create a follow-up plan scoped to the failing area before editing code.
  </how-to-verify>
  <resume-signal>Type "approved" once all commands pass, or paste the failure output.</resume-signal>
</task>

</tasks>

<verification>
- `pnpm run lint`
- `pnpm run typecheck`
- `pnpm run test:unit`
- `pnpm run test:e2e`
- `pnpm run build`
</verification>

<success_criteria>
- Refactor changes are fully covered by green automated gates.
- No regressions remain that require manual debugging before smoke check.
</success_criteria>

<output>
After completion, create `.planning/phases/18-codebase-refactor/18-07-SUMMARY.md`
</output>
