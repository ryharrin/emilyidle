---
phase: 18-codebase-refactor
plan: 3
type: execute
wave: 3
depends_on: ["18-02"]
files_modified:
  - src/game/state.ts
  - src/game/selectors/index.ts
  - src/game/actions/index.ts
autonomous: true

must_haves:
  truths:
    - "Selectors and actions no longer live in src/game/state.ts (state.ts becomes a facade)"
    - "Selectors remain pure (no window/document/localStorage/Date.now references)"
    - "App and tests can continue importing from src/game/state.ts without widespread churn"
    - "pnpm run test:unit passes after the split"
  artifacts:
    - path: "src/game/selectors/index.ts"
      provides: "Derived computations over GameState (pure selectors)"
    - path: "src/game/actions/index.ts"
      provides: "State transition functions (buy/upgrade/prestige/etc.)"
    - path: "src/game/state.ts"
      provides: "Facade module re-exporting model/data/selectors/actions"
      contains: "export"
  key_links:
    - from: "src/game/state.ts"
      to: "src/game/selectors/index.ts"
      via: "re-export"
      pattern: "export\\s+\\*\\s+from\\s+\"\\./selectors\""
    - from: "src/game/state.ts"
      to: "src/game/actions/index.ts"
      via: "re-export"
      pattern: "export\\s+\\*\\s+from\\s+\"\\./actions\""
---

<objective>
Split `src/game/state.ts` into dedicated selector and action modules, and convert `src/game/state.ts` into the stable facade re-export surface.

Purpose: Make game rules easier to navigate and refactor without circular imports or all-in-one modules.
Output: `src/game/selectors/index.ts`, `src/game/actions/index.ts`, and a much smaller `src/game/state.ts`.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/18-codebase-refactor/18-CONTEXT.md
@.planning/phases/18-codebase-refactor/18-RESEARCH.md

@src/game/state.ts
@src/game/model/types.ts
@src/game/model/state.ts
@src/game/data/items.ts
@src/game/data/upgrades.ts
@src/game/data/milestones.ts
@src/game/data/setBonuses.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract pure selectors into src/game/selectors/index.ts</name>
  <files>
src/game/state.ts
src/game/selectors/index.ts
  </files>
  <action>
- Create `src/game/selectors/index.ts` and move pure selector/derived functions from `src/game/state.ts` into it.
- Keep selector function names and signatures the same.
- Rule: selectors must not touch `window`, `document`, `localStorage`, or call `Date.now()` internally.
- Update imports inside selectors to depend on `src/game/model/types.ts` and `src/game/data/*` (as needed) rather than importing from `src/game/state.ts` (avoid circular deps).
- Update `src/game/state.ts` to re-export the moved selectors so existing import sites keep working.
  </action>
  <verify>pnpm run typecheck</verify>
  <done>
- `src/game/selectors/index.ts` exists and exports selector functions previously in `src/game/state.ts`.
- `src/game/state.ts` re-exports selectors from `./selectors`.
- `pnpm run typecheck` succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract actions into src/game/actions/index.ts and convert state.ts into a facade</name>
  <files>
src/game/state.ts
src/game/actions/index.ts
src/game/selectors/index.ts
  </files>
  <action>
- Create `src/game/actions/index.ts` and move state transition functions (buy/upgrade/prestige/reset/unlock/etc.) out of `src/game/state.ts` into it.
- Update imports inside actions to depend on `src/game/model/types.ts`, `src/game/data/*`, and `src/game/selectors/index.ts` as needed.
  - Do not import from `src/game/state.ts` inside `src/game/actions/*`.
- Convert `src/game/state.ts` into a facade module:
  - Re-export model types/state constructors from `src/game/model/*`.
  - Re-export static definitions from `src/game/data/*`.
  - Re-export selectors and actions.
- Audit the current `src/game/state.ts` export surface and preserve all existing exports via re-exports (or explicitly list intentional removals if any).
- Ensure there are no circular import errors and that app/tests can continue to import from `src/game/state.ts`.
  </action>
  <verify>pnpm run test:unit && test -z "$(rg -n '\\b(window|document|localStorage|Date\\.now)\\b' src/game/selectors || true)"</verify>
  <done>
- `src/game/state.ts` primarily re-exports from `model/`, `data/`, `selectors/`, and `actions/`.
- All pre-refactor exports from `src/game/state.ts` remain available via re-exports (or intentional removals are explicitly documented in the summary).
- No circular import errors in TypeScript build.
- `pnpm run test:unit` succeeds.
- `src/game/selectors/**` contains no direct references to `window`, `document`, `localStorage`, or `Date.now()`.
  </done>
</task>

</tasks>

<verification>
- `pnpm run typecheck`
- `pnpm run test:unit`
</verification>

<success_criteria>
- Game selectors and actions are split into focused modules.
- `src/game/state.ts` remains the stable import surface (facade pattern).
</success_criteria>

<output>
After completion, create `.planning/phases/18-codebase-refactor/18-03-SUMMARY.md`
</output>
