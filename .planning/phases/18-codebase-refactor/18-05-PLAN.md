---
phase: 18-codebase-refactor
plan: 5
type: execute
wave: 4
depends_on: ["18-03", "18-04"]
files_modified:
  - src/App.tsx
  - src/game/runtime/isTestEnvironment.ts
  - src/game/runtime/useGameRuntime.ts
autonomous: true

must_haves:
  truths:
    - "Game runtime side-effects (RAF tick + autosave + lifecycle save) are encapsulated outside UI components"
    - "Simulation loop stays disabled in unit tests (no flakiness introduced)"
    - "Save/load behavior and localStorage contracts remain unchanged"
  artifacts:
    - path: "src/game/runtime/isTestEnvironment.ts"
      provides: "Single helper used to gate the runtime in tests"
      exports: ["isTestEnvironment"]
    - path: "src/game/runtime/useGameRuntime.ts"
      provides: "Hook that owns RAF tick + autosave + lifecycle persistence"
      exports: ["useGameRuntime"]
  key_links:
    - from: "src/App.tsx"
      to: "src/game/runtime/useGameRuntime.ts"
      via: "React hook call"
      pattern: "useGameRuntime\\("
    - from: "src/game/runtime/useGameRuntime.ts"
      to: "src/game/runtime/isTestEnvironment.ts"
      via: "test gating"
      pattern: "isTestEnvironment\\(\\)"
---

<objective>
Move game runtime orchestration (RAF ticking, autosave cadence, lifecycle persistence, and test-environment gating) out of `src/App.tsx` into a dedicated hook.

Purpose: Keep UI components focused on rendering/events, and isolate side effects for safer iteration.
Output: `src/game/runtime/useGameRuntime.ts` + updated `src/App.tsx` that uses it.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/18-codebase-refactor/18-CONTEXT.md
@.planning/phases/18-codebase-refactor/18-RESEARCH.md

@src/App.tsx
@src/game/persistence.ts
@src/game/sim.ts
@tests/collection-loop.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Introduce src/game/runtime/useGameRuntime.ts and move RAF + autosave orchestration out of App.tsx</name>
  <files>
src/game/runtime/isTestEnvironment.ts
src/game/runtime/useGameRuntime.ts
src/App.tsx
  </files>
  <action>
- Create `src/game/runtime` if it does not exist.
- Create `src/game/runtime/isTestEnvironment.ts` with a single exported function `isTestEnvironment()` that matches the current semantics used to disable the sim loop in tests.
- Create `src/game/runtime/useGameRuntime.ts` and move the following responsibilities out of `src/App.tsx` with minimal behavior change:
  - requestAnimationFrame loop (including frame delta clamping / tick cadence)
  - `stateRef`/latest-state tracking used by the loop
  - autosave timers/cadence and “dirty” tracking
  - page lifecycle persistence hooks (visibilitychange/pagehide or equivalent used today)
- Design the hook API to minimize coupling:
  - Accept dependency callbacks rather than importing from UI (e.g., pass `step`, `loadSaveFromLocalStorage`, `persistSaveToLocalStorage`).
  - Return `{ state, setState, lastSimulatedAtMs, setLastSimulatedAtMs }` (and any additional callbacks needed for existing UI actions).
- Update `src/App.tsx` to call `useGameRuntime` and use the returned state instead of owning orchestration logic.
  </action>
  <verify>pnpm run typecheck</verify>
  <done>
- `src/game/runtime/useGameRuntime.ts` exists and owns the RAF loop and autosave/lifecycle effects.
- `src/App.tsx` no longer contains the core orchestration implementation.
- `pnpm run typecheck` succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate runtime gating and persistence behavior via unit + e2e tests</name>
  <files>
src/App.tsx
src/game/runtime/useGameRuntime.ts
  </files>
  <action>
- Run unit tests to ensure the runtime loop does not make tests flaky or hang.
- Run Playwright to ensure save/load + core tab interactions still behave the same.
- Fix any regressions by adjusting hook wiring (do not change save payload shape/keys).
  </action>
  <verify>pnpm run test:unit && pnpm run test:e2e</verify>
  <done>
- `pnpm run test:unit` succeeds.
- `pnpm run test:e2e` succeeds.
  </done>
</task>

</tasks>

<verification>
- `pnpm run typecheck`
- `pnpm run test:unit`
- `pnpm run test:e2e`
</verification>

<success_criteria>
- Runtime side effects are isolated in `src/game/runtime/*`.
- Tests remain stable and persistence behavior stays compatible.
</success_criteria>

<output>
After completion, create `.planning/phases/18-codebase-refactor/18-05-SUMMARY.md`
</output>
