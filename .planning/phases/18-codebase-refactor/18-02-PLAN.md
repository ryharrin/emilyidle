---
phase: 18-codebase-refactor
plan: 2
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - src/game/state.ts
  - src/game/data/items.ts
  - src/game/data/upgrades.ts
  - src/game/data/milestones.ts
  - src/game/data/setBonuses.ts
  - src/game/selectors/index.ts
  - src/game/actions/index.ts
autonomous: true

must_haves:
  truths:
    - "Player can still buy watches/upgrades and see derived stats update (no gameplay regression)"
    - "Static game definitions are separated from selectors/actions (no more all-in-one src/game/state.ts)"
    - "Selectors remain pure (no localStorage/window/Date side effects)"
    - "App and tests still import from src/game/state.ts without widespread churn"
  artifacts:
    - path: "src/game/data/items.ts"
      provides: "Watch item definitions (data only)"
    - path: "src/game/selectors/index.ts"
      provides: "Derived computations over GameState"
    - path: "src/game/actions/index.ts"
      provides: "State transition functions (buy/upgrade/prestige/etc.)"
    - path: "src/game/state.ts"
      provides: "Facade module re-exporting data/selectors/actions"
      contains: "export"
  key_links:
    - from: "src/game/state.ts"
      to: "src/game/data/items.ts"
      via: "re-export"
      pattern: "export\\s+\\{[^}]*getWatchItems"
    - from: "src/game/state.ts"
      to: "src/game/selectors/index.ts"
      via: "re-export"
      pattern: "export\\s+\\*\\s+from\\s+\"\\./selectors\""
    - from: "src/game/state.ts"
      to: "src/game/actions/index.ts"
      via: "re-export"
      pattern: "export\\s+\\*\\s+from\\s+\"\\./actions\""
---

<objective>
Split `src/game/state.ts` into smaller modules: static data, pure selectors, and state transition actions, while keeping `src/game/state.ts` as the stable import surface.

Purpose: Make game rules easier to navigate and change without unintended coupling.
Output: `src/game/data/*`, `src/game/selectors/*`, `src/game/actions/*`, and a much smaller `src/game/state.ts`.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/18-codebase-refactor/18-CONTEXT.md
@.planning/phases/18-codebase-refactor/18-RESEARCH.md

@src/game/state.ts
@src/game/model/types.ts
@src/game/model/state.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract static definitions into src/game/data/*</name>
  <files>
src/game/state.ts
src/game/data/items.ts
src/game/data/upgrades.ts
src/game/data/milestones.ts
src/game/data/setBonuses.ts
  </files>
  <action>
- Create `src/game/data/items.ts`, `src/game/data/upgrades.ts`, `src/game/data/milestones.ts`, `src/game/data/setBonuses.ts`.
- Move static definition data (arrays/records/constants and their helper types) out of `src/game/state.ts` into these modules.
- Keep these data modules side-effect free and React-free.
- Update `src/game/state.ts` to import and (where needed) re-export these definitions so existing callers donâ€™t break.
- Avoid behavior changes: do not change numeric constants, costs, thresholds, or ids.
  </action>
  <verify>pnpm run typecheck</verify>
  <done>
- Static definitions no longer live in `src/game/state.ts`.
- New `src/game/data/*` modules exist and are imported by `src/game/state.ts`.
- `pnpm run typecheck` succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract selectors and actions into dedicated modules and convert state.ts into a facade</name>
  <files>
src/game/state.ts
src/game/selectors/index.ts
src/game/actions/index.ts
  </files>
  <action>
- Create `src/game/selectors/index.ts` and move pure selector/derived functions from `src/game/state.ts` into it.
  - Rule: selectors must not touch `window`, `document`, `localStorage`, or call `Date.now()` internally.
- Create `src/game/actions/index.ts` and move state transition functions (buy/upgrade/prestige/reset/unlock/etc.) out of `src/game/state.ts` into it.
- Update imports inside selectors/actions to depend on `src/game/model/types.ts` (and `src/game/data/*` as needed) rather than importing from `src/game/state.ts` to avoid circular dependencies.
- Update `src/game/state.ts` to become a facade:
  - Re-export model types/state constructors from `src/game/model/*`.
  - Re-export definitions from `src/game/data/*`.
  - Re-export selectors and actions.
- Ensure the app and tests can continue to import from `src/game/state.ts` without requiring widespread import churn.
  </action>
  <verify>pnpm run test:unit && test -z "$(rg -n '\\b(window|document|localStorage|Date\\.now)\\b' src/game/selectors || true)"</verify>
  <done>
- `src/game/state.ts` primarily re-exports from `model/`, `data/`, `selectors/`, and `actions/`.
- No circular import errors in TypeScript build.
- `pnpm run test:unit` succeeds.
- `src/game/selectors/**` contains no direct references to `window`, `document`, `localStorage`, or `Date.now()`.
  </done>
</task>

</tasks>

<verification>
- `pnpm run typecheck`
- `pnpm run test:unit`
</verification>

<success_criteria>
- Game definitions, selectors, and actions are separated into focused modules.
- No gameplay behavior changes beyond incidental bug fixes discovered during refactor.
</success_criteria>

<output>
After completion, create `.planning/phases/18-codebase-refactor/18-02-SUMMARY.md`
</output>
