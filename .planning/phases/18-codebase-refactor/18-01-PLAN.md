---
phase: 18-codebase-refactor
plan: 1
type: execute
wave: 1
depends_on: []
files_modified:
  - src/game/state.ts
  - src/game/model/types.ts
  - src/game/model/state.ts
  - src/game/persistence.ts
  - src/game/sim.ts
autonomous: true

must_haves:
  truths:
    - "GameState types and constructors live in a dedicated model module (not in src/game/state.ts)"
    - "Existing imports from src/game/state.ts keep working (facade re-exports preserved)"
    - "Save load and simulation tick still compile and unit tests pass with identical public signatures"
  artifacts:
    - path: "src/game/model/types.ts"
      provides: "GameState + ID/type definitions"
      contains: "export type GameState"
    - path: "src/game/model/state.ts"
      provides: "Initial state + createStateFromSave (pure model helpers)"
      exports: ["createInitialState", "createStateFromSave"]
    - path: "src/game/state.ts"
      provides: "Facade module that re-exports model/types"
      contains: "export type"
  key_links:
    - from: "src/game/state.ts"
      to: "src/game/model/types.ts"
      via: "type re-export"
      pattern: "export type\\s+\\{[^}]*GameState"
    - from: "src/game/state.ts"
      to: "src/game/model/state.ts"
      via: "function re-export"
      pattern: "export\\s+\\{[^}]*createInitialState"
---

<objective>
Create a dedicated game model layer (types + state construction) and turn `src/game/state.ts` into the start of a facade, so later refactors can split selectors/actions without breaking call sites.

Purpose: Reduce coupling and make domain refactors safer while preserving behavior.
Output: New `src/game/model/*` modules + updated `src/game/state.ts` facade wiring.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/18-codebase-refactor/18-CONTEXT.md
@.planning/phases/18-codebase-refactor/18-RESEARCH.md

@src/game/state.ts
@src/game/persistence.ts
@src/game/sim.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract core game types into src/game/model/types.ts</name>
  <files>
src/game/state.ts
src/game/model/types.ts
src/game/persistence.ts
src/game/sim.ts
  </files>
  <action>
- Create `src/game/model/types.ts`.
- Move all domain model types out of `src/game/state.ts` into `src/game/model/types.ts` (e.g., `GameState`, persisted-save-related types, and ID union types like watch/upgrade/milestone ids).
- Update `src/game/persistence.ts` and `src/game/sim.ts` to import model types from `src/game/model/types.ts` (or continue importing from `src/game/state.ts` if you keep facade re-exports; either is acceptable, but avoid circular deps).
- Update `src/game/state.ts` to re-export the moved types (`export type { ... } from "./model/types";`) so existing import sites keep working.
- Do not change any runtime behavior, save payload shape, or localStorage keys.
  </action>
  <verify>pnpm run typecheck</verify>
  <done>
- `src/game/model/types.ts` exists and contains `export type GameState`.
- `src/game/state.ts` no longer defines those model types directly; it re-exports them.
- `pnpm run typecheck` succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract initial state + createStateFromSave into src/game/model/state.ts</name>
  <files>
src/game/state.ts
src/game/model/state.ts
src/game/persistence.ts
  </files>
  <action>
- Create `src/game/model/state.ts`.
- Move `createInitialState` and `createStateFromSave` (and any helpers that solely support those functions) out of `src/game/state.ts` into `src/game/model/state.ts`.
- Ensure `createStateFromSave` remains backwards compatible with existing save v2 payloads and legacy migration behavior (do not change versions/keys).
- Update `src/game/persistence.ts` (and any other call sites) to import these functions from either `src/game/model/state.ts` or the `src/game/state.ts` facade.
- Update `src/game/state.ts` to re-export these functions from `./model/state` so existing import sites keep working.
  </action>
  <verify>pnpm run test:unit</verify>
  <done>
- `src/game/model/state.ts` exports `createInitialState` and `createStateFromSave`.
- `src/game/state.ts` re-exports those functions (facade preserved).
- `pnpm run test:unit` succeeds.
  </done>
</task>

</tasks>

<verification>
- `pnpm run typecheck`
- `pnpm run test:unit`
</verification>

<success_criteria>
- Game model types and state construction logic are no longer defined in `src/game/state.ts`.
- App and tests continue to compile without behavior changes.
</success_criteria>

<output>
After completion, create `.planning/phases/18-codebase-refactor/18-01-SUMMARY.md`
</output>
